% fix bugs: fixes already in kernel now
%\RequirePackage{fixltx2e}


\documentclass[10pt]{report}

% encoding of tex-file
\usepackage[utf8x]{inputenc}

% for propper Umlaute
\usepackage[T1]{fontenc}

% proper hyphenation
\usepackage[UKenglish]{babel}

% better i18n Postscript version of Knuth's cm fonts, better than cm-super
\usepackage{lmodern}

% Mathematics
\usepackage{mathtools} % extension and fixes of/in amsmath
\usepackage{amssymb} % provides symbols, loads amsfonts
\usepackage{amsthm} % provides theorem environment
\usepackage{nicefrac} % better slash fracs in inline

% For including figures, rotating or scaling text (dont use file extension)
\usepackage{graphicx}

\usepackage[postfixflatinterpret,bracketmodalinterpret,fixformat,silentconst,sidenotecalculus,longseqcontext]{logic}
\usepackage[postfixflatinterpret,bracketmodalinterpret,fixformat,silentconst,simplenames]{dL}

% own symbol definitions
\input{mathcommands}


\usepackage{rotating}
\newcommand{\I}{\dLint[state=\nu]}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{document}

\title{Delay Hybrid Systems}

\author{Lorenz Sahlmann\\ Ecole Polytechnique\\ Carnegie Mellon University}
\date{\today}

\maketitle

\chapter{Introduction}
In this work we extend Differential Dynamic Logic with Delay Differential Equations.

This requires an extension of the syntax, a (partially) redefinition of the semantics and the introduction of additional axioms and proof rules.

This results in a superset of \dL which we call \textbf{Delay Differential Dynamic Logic}.


\include{delay-differential-equations}

\include{delay-hybrid-programs}

%\include{delay-differential-logic}
\chapter{Delay Differential Dynamic Logic}
    \label{sec:delay-differential-dynamic-logic}

    \section{Axioms}
        \label{sec:axioms}



        \begin{calculus}
            % TODO: Diamond-Axiom
            % TODO: assignment-Axiom
            % TODO: test-Axiom
            % TODO: choice-Axiom
            % TODO: star-Axiom
            % TODO: forall-Axiom
            % TODO: K-Axiom
            % TODO: I-Axiom
            % TODO: V-Axiom
            % TODO: G-Axiom
            % TODO: MP-Axiom
            % TODO: CT-Axiom
            % TODO: CQ-Axiom
            % TODO: CE-Axiom
            % TODO: US-Axiom
            % TODO: replace ;
            \cinferenceRule[composeb|$;$]{composition}{
                \linferenceRule[equiv]{
                    \dbox{\alpha}{\dbox{\beta}{P}}
                }{
                    \dbox{\alpha;\beta}{P}
                }
            }{}
        \end{calculus}

        % TODO: proofs, do not change, since only mention states?


% TODO: History Axiom
        \subsection{History Axiom}
            \label{history-axiom}
            Just replace symbol by its semantical meaning
            The occurence of $\xbartau$ in expressions can be replaced by turning the (implicitely existing) time variable explicit, i.e.\
            uniform substitution $\sigma$
            allows substitution of $\xtau$ by, depending on context, $x(t-\tau)$ or $\forall{s\in[0,\tau]}{x(t-\tau)}$
            allows substitution of x, +quantifier from semantics in certain contexts
            \begin{calculus}
                \cinferenceRule[hist|hist]{history axiom}{
                    \linferenceRule[equiv]{
                        \lforall{s\in[-\tau,0]}{p(\theta(t+s))}
                    }{
                        p(\xtau)
                    }
                }{}
                %F(\xbartau) \leftrightarrow \forall\,-\tau\leq t\leq 0\, F(x(t))
            \end{calculus}
            for a piecewise continuous function $\theta\in\statespace$.

        \subsection{Axiom of Steps}
            \label{sec:axiom-of-steps}
            The \emph{Method of Steps} presented above translates into an axiom.
            %It allows to partially unwind an autonomous DDE given a analytic representation of its solution.

            % Let $\theta_0$ and $\theta$
            \begin{calculus}
                % TODO: actually doesn't need to be in a box?
                \cinferenceRule[stepsb|stpsb]{method of steps axiom}{
                    \linferenceRule[equiv]{
                        \dbox[]{\prepeat{(\hupdate{\humod{t}{0}};\hevolvein{t'=1\syssep x'=\rho(x,\xtau)}{(\chi\land 0\leq t\leq\tau)})}}{\phi}
                    }{
                        \dbox[]{\hevolvein{x'=\rho(x,\xtau)}{\chi}}{\phi}
                    }
                }{}
                % \xbartau = \theta_0 \rightarrow [x'=\theta(\xbartaut{t})]\phi
                % \leftrightarrow
                % \left(\forall 0\leq t\leq\tau: [x:= y(t)]\phi \right)
                % \wedge \xbartaut{\tau} = y \rightarrow [x'=\theta (\xbartaut{t})]\phi

            \end{calculus}
            % where $\forall 0\leq t\leq\tau$, $y'(t)=\theta(\theta_0)$, i.e.\ $y$ is a local solution of the DDE. The solution must be expressible in polynomial form so that the axiom leads to decidable arithmetic.

            (Since the DDE is autonomous, we can emit the time index.)

            \begin{proof}
                apply methods of steps
            \end{proof}

    \section{Proof Rules}
        \label{sec:proof-rules}
We keep the standard sequent calculus proof rules

        \begin{calculus}
            \cinferenceRule[close|id]{close by identity}{
                \linferenceRule[sequent]{
                %\lsequent{}{}
                }{
                    \lsequent{P,\Gamma}{P,\Delta}
                }
            }{}
            \cinferenceRule[allR|$\forall$R]{for all right proof rule}{
                \linferenceRule[sequent]{
                    \lsequent{\Gamma}{p(y),\Delta}
                }{
                    \lsequent{\Gamma}{\lforall{x}{p(x)},\Delta}
                }
            }{$y\notin\Gamma,\Delta$}
            \cinferenceRule[andR|$\land$R]{and right proof rule}{
                \linferenceRule[sequent]{
                    \lsequent{\Gamma} {p,\Delta}
                    &\lsequent{\Gamma} {q,\Delta}
                }{\lsequent{\Gamma} {p\land q,\Delta}}
            }{}
            \cinferenceRule[andL|$\land$L]{and left proof rule}{
                \linferenceRule[sequent]{
                    \lsequent{\Gamma, p, q} {\Delta}
                }{\lsequent{\Gamma, p\land q} {\Delta}}
            }{}
            \cinferenceRule[implyR|$\limply$R]{imply right proof rule}{
                \linferenceRule[sequent]{
                    \lsequent{\Gamma,p} {q,\Delta}}{
                    \lsequent{\Gamma} {p\limply q,\Delta}}
            }{}
            % TODO: replace := by command
            \cinferenceRule[assignb|$\mathrel{{:}{=}}$]{discrete assignment}{
                \linferenceRule[sequent]{
                    \lsequent{\Gamma,x=e}{P,\Delta}
                }{\lsequent{\Gamma}{\dbox{\hupdate{\humod{x}{e}}}{P},\Delta}}
            }{$x\notin\Gamma,\Delta$}
            \cinferenceRule[loop|loop]{loop invariant}{
                \linferenceRule[sequent]{
                    \lsequent{\Gamma}{J,\Delta}
                    &\lsequent{J}{\dbox{\alpha}{J}}
                    &\lsequent{J}{P}
                }{\lsequent{\Gamma}{\dbox{\prepeat{\alpha}}{P},\Delta}}
            }{}
            \cinferenceRule[DC|DC]{differential cut}{
                \linferenceRule[sequent]{
                    \lsequent{\Gamma}{\dbox{\hevolvein{x'=f(x)}{\chi}}{r(x)},\Delta}
                    &\lsequent{\Gamma}{\dbox{\hevolvein{x'=f(x)}{\chi\land r(x)}}{P}}
                }{\lsequent{\Gamma}{\dbox{\hevolvein{x'=f(x)}{\chi}}{P},\Delta}}
            }{}
            \cinferenceRule[dI|dI]{differential invariant}{
                \linferenceRule[sequent]{
                    \lsequent{\Gamma,Q}{P,\Delta}
                    % FIXME: replace ':= by correct command
                    &\lsequent{Q}{\dbox{x':=f(x)}{(P)'}}
                }{\lsequent{\Gamma}{\dbox{\hevolvein{x'=f(x)}{\chi}}{P},\Delta}}
            }{}
            \cinferenceRule[dW|dW]{differential weakening}{
                \linferenceRule[sequent]{
                    \lsequent{\Gamma}{\lforall{x}{(\chi\limply P)},\Delta}
                }{\lsequent{\Gamma}{\dbox{\hevolvein{x'=f(x)}{\chi}}{P},\Delta}}
            }{}
        \end{calculus}

        % TODO: Rule of Steps
        \subsection{Rule of Steps}
            \label{sec:rule-of-steps}

            condition valid for initial condition and given condition for a $s\leq t$ then condition holds after dde-evolution of max time tau and safety follows from condition then condition holds after dde with mentioned initial condition
            % \begin{equation}
            % \frac{\Gamma(\xbartaut{0})\rightarrow F(\xbartaut{0})\quad F(\xbartaut{s})\rightarrow [x'=\theta(\xbartaut{t})\,\&\,t\leq\tau]F(\xbartaut{t}) \quad F(\xbartaut{t})\rightarrow\phi}{\Gamma(\xbartaut{0}) \rightarrow [x'=\theta(\xbartaut{t})]\phi}
            % \end{equation}

            \begin{calculus}
                % FIXME: \landS -> steps
                \cinferenceRule[steps|stps]{steps proof rule}{
                    \linferenceRule[sequent]{
                        \lsequent{\Gamma}{F,\Delta}
                        &\lsequent{t=0,F(\theta(t-\tau))}{\dbox[]{\hevolvein{t'=1\syssep x'=\rho(x,\theta(t-\tau))}{(\chi\land 0\leq t\leq\tau)}}{F}}
                        &\lsequent{F}{\phi}
                    }{
                        \lsequent{\Gamma}{\dbox[]{\hevolvein{x'=\rho(x,\xtau)}{\chi}}{\phi},\Delta}
                    }
                }{}
            \end{calculus}

        \subsection{Delay Differential Induction}
            \label{sec:delay-differential-induction}

            \begin{calculus}
                \cinferenceRule[DDI|DDI]{delay differential induction proof rule}{
                    \linferenceRule[sequent]{
                        \lsequent{\Gamma}{F,\Delta}
                        &\lsequent{\chi,0\leq t\leq\tau,F(\theta(t-\tau))}{\dbox[]{\hevolve{x':=\rho(x,\theta(t-\tau))}}{(F)'}}
                        &\lsequent{F}{\phi}
                    }{
                        \lsequent{\Gamma}{\dbox[]{\hevolvein{x'=\rho(x,\xtau)}{\chi}}{\phi,\Delta}}
                    }
                }{}
            \end{calculus}

            %\begin{proof}\small
            \begin{sidewaysfigure}\footnotesize
            \centering
            \begin{sequentdeduction}[]
                \linfer[stepsb]{
                    \linfer[loop]{
                        % FIXME: formel zu hoch
                        \lsequent{\Gamma(\xtau)}{F(\xtau),\Delta}
                        &\linfer[assignb composeb]{
                            \linfer[DC]{
                                \linfer[dI]{
                                    (1)
                                }{
                                    \lsequent{F(\xtau),t=0}{\dbox{\hevolvein{t'=1\syssep x'=\eta(x,\xtau)}{(\chi\land 0\leq t\leq\tau\land F(x(t-\tau)))}}{F(\xtau)}}
                                }
                                &\linfer[]{
                                    (2)
                                }{
                                    \lsequent{F(\xtau),t=0}{\dbox{\hevolvein{t'=1\syssep x'=\eta(x,\xtau)}{(\chi\land 0\leq t\leq\tau)}}{F(x(t-\tau))}}
                                }
                            }{
                                \lsequent{F(\xtau),t=0}{\dbox[]{\hevolvein{t'=1\syssep x'=\eta(x,\xtau)}{(\chi\land 0\leq t\leq\tau)}}{F(\xtau)}}
                            }
                        }{
                            \lsequent{F(\xtau)}{\dbox[]{\hupdate{\humod{t}{0}}; \hevolvein{t'=1\syssep x'=\eta(x,\xtau)}{(\chi\land 0\leq t\leq\tau)}}{F(\xtau)}}
                        }
                        \lsequent{F(\xtau)}{\phi(\xtau)}
                    }{
                    \lsequent{\Gamma(\xtau)}{\dbox{\prepeat{(\hupdate{\humod{t}{0}}; \hevolvein{t'=1\syssep x'=\eta(x,\xtau)}{(\chi\land 0\leq t\leq\tau))}}}{\phi(\xtau),\Delta}}}
                }
                {\lsequent{\Gamma(\xtau)}{\dbox{\hevolvein{x'=\eta(x,\xtau)}{\chi}}{\phi(\xtau),\Delta}}}
            \end{sequentdeduction}

            % TODO: ref to here: (2)
            \begin{sequentdeduction}
                \linfer[hist]{
                    \linfer[dW]{
                        \linfer[allR]{
                            \linfer[implyR]{
                                \linfer[]{
                                    \lclose
                                }{
                                    \lsequent{\lforall{s\in[-\tau,0]}{F(\theta(s))},t=0,\chi(r,y),0\leq r\leq\tau}{F(\theta(r-\tau))}
                                }
                            }{
                                \lsequent{\lforall{s\in[-\tau,0]}{F(\theta(s))},t=0}{\chi(r,y)\land 0\leq r\leq\tau\limply F(\theta(r-\tau))}
                            }
                        }{
                            \lsequent{\lforall{s\in[-\tau,0]}{F(\theta(s))},t=0}{\lforall{(t,x)}{(\chi\land 0\leq t\leq\tau\limply F(\theta(t-\tau)))}}
                        }
                    }{
                        \lsequent{\lforall{s\in[-\tau,0]}{F(\theta(s))},t=0}{\dbox{\hevolvein{t'=1\syssep x'=\eta(x,\theta(t-\tau))}{(\chi\land 0\leq t\leq\tau)}}{F(\theta(t-\tau))}}
                    }
                }{
                    \lsequent{F(\xtau),t=0}{\dbox{\hevolvein{t'=1\syssep x'=\eta(x,\xtau)}{(\chi\land 0\leq t\leq\tau)}}{F(x(t-\tau))}}
                }
            \end{sequentdeduction}

            % TODO: ref to here: (1)
            \begin{sequentdeduction}
                \linfer[DC]{
                    \linfer[dI]{
                        \linfer[hist]{
                            \linfer[]{
                                \lclose
                            }{
                                \lsequent{\lforall{s\in[-\tau,0]}{F(\theta(s))}}{F(\theta(0))}
                            }
                        }{
                            \lsequent{F(\xtau),t=0,Q, F(x(t-\tau))}{F(t)}
                        }
                        % TODO: Q=\chi, 0\leq t\leq\tau
                        &\lsequent{Q, F(x(t-\tau)))}{\dbox{t':=1, x':=\eta(x,\xtau)}{(F(x(t)))'}}
                        %}
                    }{
                        \lsequent{F(\xtau),t=0}{\dbox{\hevolvein{t'=1\syssep x'=\eta(x,\xtau)}{(Q\land F(x(t-\tau)))}}{F(t)}}
                    }
                    &\linfer[hist]{
                        (3)
                    }{
                        \lsequent{F(\xtau),t=0}{\dbox{\hevolvein{t'=1\syssep x'=\eta(x,\xtau)}{(Q\land F(x(t-\tau))\land F(x(t)))}}{F(\xtau)}}
                    }
                }{
                    \lsequent{F(\xtau),t=0}{\dbox{\hevolvein{t'=1\syssep x'=\eta(x,\xtau)}{(Q\land F(x(t-\tau)))}}{F(\xtau)}}
                }
            \end{sequentdeduction}
            % TODO: ref here (3)
            \begin{sequentdeduction}
                \linfer[hist]{
                    \linfer[dW]{
                        \linfer[allR]{
                            \linfer[implyR]{
                                \linfer[close]{
                                    \lclose
                                }{
                                    \lsequent{\lforall{s\in[-\tau,0]}{F(\theta(s))}, t=0, Q, F(\theta(-\tau)), F(\theta(0))}{\lforall{r\in[-\tau,0]}{F(\theta(r))}}
                                }
                            }{
                                \lsequent{\lforall{s\in[-\tau,0]}{F(\theta(s))}, t=0}{((Q\land F(\theta(-\tau))\land F(\theta(0)))\limply\lforall{r\in[-\tau,0]}{F(\theta(r))})}
                            }
                        }{
                            \lsequent{\lforall{s\in[-\tau,0]}{F(\theta(s))}, t=0}{\lforall{(t,x)}{((Q\land F(\theta(-\tau))\land F(\theta(0)))\limply\lforall{r\in[-\tau,0]}{F(\theta(r))})}}
                        }
                    }{
                        \lsequent{\lforall{s\in[-\tau,0]}{F(\theta(s))}, t=0}{\dbox{\hevolvein{t'=1\syssep x'=\eta(x,\xtau)}{(Q\land F(\theta(-\tau))\land F(\theta(0)))}}{(\lforall{r\in[-\tau,0]}{F(\theta(r))})}}
                    }
                }{
                    \lsequent{F(\xtau),t=0}{\dbox{\hevolvein{t'=1\syssep x'=\eta(x,\xtau)}{(Q\land F(x(t-\tau))\land F(x(t)))}}{F(\xtau)}}
                }
            \end{sequentdeduction}
            \end{sidewaysfigure}
            \normalsize
            %\end{proof}

        \subsection{Delay Differential Invariant}
            \label{sec:delay-differential-invariant}



            loop and differential invariants are of form $\lforall{s\in[-\tau,0]}{F(x(s))}$
            can they have $x$?

            Meaning of derivative $(F(\xtau))'=\lforall{s\in[-\tau,0]}{(F(x(t+s)))'}$ would lead to occurrence of derivative of init cond, which we don't know

            Mentioning $\xtau$ in the invariant differential invariant is not permitted, since derivation would lead to the occurrence of the symbol $x_{2\tau}$, whose properties are out of the scope of the current state.

        % TODO: Example
        \subsection{Examples}
            \label{sec:examples}

            \subsubsection{Example 1}
                \label{sec:ddi-example-1}
                Consider the non-linear first order delay differential equation
                \begin{equation}
                    x'(t) = \begin{cases}
                         x(t-1) & t \geq 0\\
                         \theta(t)\geq 0 & t \in [-1,0]
                    \end{cases}
                \end{equation}
                Using $F\equiv(x^3\leq 0)$ we prove that the solution stays non-negativ for all time $t$.
                \begin{sequentdeduction}
                    \linfer[DDI]{
                        \linfer[]{
                            \lclose
                        }{
                            \lsequent{\xtau[1]\geq 0}{\xtau[1]^3\geq 0}
                        }
                        &\linfer[]{
                            \linfer[]{
                                \linfer[closeTrue]{
                                    \lclose
                                }{
                                    \lsequent{}{3x^2\theta\geq 0}
                                }
                            }{
                                \lsequent{0\geq t\geq\tau,\theta(t)^3\geq 0}{\dbox{ x':=\theta(t)}{(3x(t)^2 x'\geq 0)}}
                            }
                        }{
                            %\lclose
                            \lsequent{0\geq t\leq\tau,\theta(t)^3\geq 0}{\dbox{t':=1, x':=\theta(t)}{\der{x\geq 0}}}
                        }
                        &\linfer[]{
                            \lclose
                        }{
                            \lsequent{\xtau[1]^3\geq 0}{\xtau[1]\geq 0}
                        }
                    }{
                        \lsequent{\xtau[1]\geq 0}{\dbox{x'=\xtau[1]}{(\xtau[1]\geq 0)}}
                    }
                \end{sequentdeduction}
                In the same way we can prove that the solution stays negative for all $t$, if the initial condition is non-positive.

            \subsubsection{Example 2}
                \label{sec:ddi-example-2}
                Consider the non-linear first order delay differential equation
                \begin{equation}
                    x'(t) = \begin{cases}
                         -x(t-1)^2 & t \geq 0\\
                         t & t \in [-1,0]
                    \end{cases}
                \end{equation}
                Using $F\equiv(x^3\leq 0)$ we prove that the solution stays non-positiv.
                \begin{sequentdeduction}
                    \linfer[DDI]{
                        \linfer[]{
                            \lclose
                        }{
                            \lsequent{\xtau[1]\leq 0}{\xtau[1]^3\leq 0}
                        }
                        &\linfer[]{
                            \linfer[]{
                                \linfer[closeTrue]{
                                    \lclose
                                }{
                                    \lsequent{}{-3x^2\theta^2\leq 0}
                                }
                            }{
                                \lsequent{0\leq t\leq\tau,\theta(t)^3\leq 0}{\dbox{ x':=-\theta(t)^2}{(-3x(t)^2 x'\leq 0)}}
                            }
                        }{
                            %\lclose
                            \lsequent{0\leq t\leq\tau,\theta(t)^3\leq 0}{\dbox{t':=1, x':=-\theta(t)^2}{\der{x\leq 0}}}
                        }
                        &\linfer[]{
                            \lclose
                        }{
                            \lsequent{\xtau[1]^3\leq 0}{\xtau[1]\leq 0}
                        }
                    }{
                        \lsequent{\xtau[1]\leq 0}{\dbox{x'=-\xtau[1]^2}{(\xtau[1]\leq 0)}}
                    }
                \end{sequentdeduction}
                This proof doesn't even need any premisse about $\xtau$ in the induction step.
            \subsubsection{Second Example}
            \label{sec:second-example}

            \subsubsection{Example 3}
                \label{sec:ddi-example-3}

                We want to proof the safety condition $\phi\equiv(-1\leq x\wedge x\leq 1)$ for the continuous program with delay differential equation
                \begin{equation}
                    \forall\,t\in[-\tau,0]:\,-1\leq\xbartaut{0}(t)\wedge\xbartaut{0}(t)\leq 1
                    \rightarrow
                    [x'=-\xtau] (\forall\,s\in[-\tau,0]:\,-1\leq\xbartaut{t}(s)\wedge\xbartaut{t}(s)\leq 1)
                \end{equation}
                in explicit quantified representation. It can be simplified by using an implicit time variable and a context depending meaning of $\xtau$
                \begin{equation}
                    -1\leq\xtau\leq 1 \rightarrow [x'=-\xtau]\phi.
                \end{equation}

                We apply the rule of steps using the safety condition $\phi$ as step condition $F(x)\equiv(\forall\,t\in[-\tau,0]:\,-1\leq x(t)\wedge x(t)\leq 1)$.

                The first and third premisses hold. The second by ??? (delay differential invariant)

                Use the algebraic differential invariant $F\equiv(-1\leq x^3\wedge x^3\leq1)$, which is valid for the initial condition. Differentiation leads to the inequalities, which needs to be shown $\forall t\in[0,\tau]$
                \begin{equation}
                    0\leq 3\,x(t)^2 x'(t) = -3\,x(t)^2 \xtau(t)
                \end{equation}

                This holds since



\nocite{*}
\bibliographystyle{plain}
\bibliography{Bibliography}

\end{document}
