\chapter{Hybrid Programs with DDEs}\label{hybrid-programs-with-ddes}

We extent hybrid programs (\HPs) and formulae of classic \dL with syntax, semantics, axiomatization and proof rules which allow to deal with Delay Differential Equations.
%Is a super set, \dL is a fragment

Similiar to first-order logic and essentially as an extension of dL we define delay differential logic

\section{Example}
    \label{example-hp-cars}
    To motivate the need of being able to treat Delayed Differential Equations in hybrid programs, we present some examples.

    \subsection{Leading and Following Car}

    \subsection{Network Induced Delay in Control Loops}

\section{Syntax}
    \label{sec:syntax}

    $\allvars$ set of \textit{all variables} and $\diffvars\defeq\{\D{x} \with x\in\allvars\}$ set of \textit{differential symbols} and set of \textit{delayed variables} $\delayedvars\defeq\{\xtau \with x\in\allvars\}$

    variables $x,y,z\in\allvars$ with their differential symbols $\D{x},\D{y},\D{z}\in\D{\allvars}$

    % TODO: meaning of function, predicate, constant
    function symbols $f,g,h$

    predicate symbols $p,q,r$

    program constants $\ausprg, \busprg, c$, may be in $\rationals$

    defined inductively

    \begin{definition}[Terms]
        \label{def:syntax-terms}

        We extent the grammar defining \textbf{terms} with a symbol for a \textbf{delayed variable}
        \begin{equation}
            \astrm,\bstrm \Coloneqq x \mid \xtau \mid \D{x} \mid c \mid \astrm+\bstrm \mid \astrm\cdot\bstrm
        \end{equation}

        % subtraction and division

        The symbol $x$ is only allowed in the right hand side of a DDE and in evolution domain constraints, not in other formulas. The latter may only contain $\xtau$.

    \end{definition}

    where $x$ and where $\xtau$?
    %The grammars for hybrid programs and \dL formulas remain unchanged, but are shown here for completeness.

    \begin{definition}[Hybrid program]
        \label{def:syntax-HP}

        grammar
        $\asprg, \bsprg$ \HPs, program constants $\ausprg$, variable $x$, term $\astrm$ (possibly containing $x$ or $\xtau$?), formula $\bsfml$ of first-order logic of real arithmetic (\FOLR)

        % TODO: first-order logic of real arithmetic formulas include \xtau?
        % TODO: difference dL formula and FOLR formula

        \begin{equation}
            % TODO: replace ;
            \asprg, \bsprg \Coloneqq
                a \mid
                \hupdate{\humod{x}{\astrm}} \mid
                \Dupdate{\Dumod{\D{x}}{\astrm}} \mid
                \htest{\bsfml} \mid
                \hchoice{\asprg}{\bsprg} \mid
                \asprg;\bsprg \mid
                \hrepeat{\asprg} \mid
                \hevolvein{\D{x}=\astrm}{\bsfml}
        \end{equation}

        difference to \dL, refer to Section \ref{sec:dynamic-semantics} for meaning of the following, different meaning for formulae

        assignment, discretely at an instant of time
        test of formula in current state
        nondeterministic choice
        sequential composition
        nondeterministic repetition
        delay differential equation with restricted evolution, due to domain constraint $\bsfml$, follow arbitrary amount of time
        ODE still possible

    \end{definition}

    \begin{definition}[(\dL) formula]
        \label{def:syntax-formula}

        formulas of (differential dynamic logic \dL)
        defined by grammar
        with \dL formulas $\asfml,\bsfml$, terms $\astrm,\bstrm,\range{\istrm{1}}{\istrm{k}}$,
        % TODO: replace with command for predicate symbols, quantifier symbol
        predicate symbol $p$, quantifier symbol $C$, variable $x$, \HP $\asprg$

        \begin{equation}
            \asfml,\bsfml \Coloneqq \astrm\geq\bstrm \mid p(\range{\istrm{1}}{\istrm{k}}) \mid \contextapp{C}{\asfml} \mid \lnot\asfml \mid \asfml\land\bsfml \mid \lforall{x}{\asfml} \mid \lexists{x}{\asfml} \mid \dbox{\asprg}{\asfml} \mid \ddiamond{\asprg}{\asfml}
        \end{equation}
        % TODO: need = in formulas ?
        other operators, such as $>,\leq,<,\lor,\limply,\lbisubjunct$ can be derived from $\land,\lnot$

        modal formula $\dbox{\asprg}{\asfml}$ : $\asfml$ holds in the state after all runs of $\asprg$, dual: there is a run
        quantifier symbols $C$, with formula as argument are higher order predicate symbols and bind the variables of $\asfml$

    \end{definition}

\section{Dynamic Semantics}
    \label{sec:dynamic-semantics}
    % TODO: fix display of semantics [[]]
    \begin{equation}
        \imodel[dL]{\IdL}{x}
    \end{equation}

    Following $\iget[state]{\IFOL}\lenvelope$ the remark to the solution of a DDE, we augment the \textbf{state space} in \dL to $\statespace$, the set of piecewise continuous functions on $[-\tau,0]$, as defined in Definition \ref{definition-piecewise-continuous}.

    Variables remember limited history
    hence implicit notion of underlying time/clock


    We denote by $\states$ the set of states. A state $\omega\in\states$ is a mapping
    \begin{equation}
        \omega : \allvars\cup\diffvars\rightarrow\statespace
    \end{equation}
    that assigns a \emph{history} (function) $\xbartau$ to each variable and differential symbol.

    %FIXME: need diff var symbol? can determine derivative from x? need pw diffable?

    rewriting history is not allowed, only values at current time instant can be changed $\modif{\nu}{x}{r}$ denotes state which is equal to state $\nu$ except for the value of variable $x$ at the time $t=0$, which is changed to $r\in\R$. values of $x$ for time before do not change

    % TODO: Abgrenzung zu Trace Semantics
    % The temporal character of delay differential equations (they depend on their own temporal evolution with limited horizon) suggests the introduction of trace semantics.
    %
    % However, we go the way of introducing transition semantics with an augmented state space.

    \begin{definition}[Semantics of terms]
        \label{def:sematic-terms}
        semantics of a term $\astrm$ in a state $\nu\in\statespace$ (of time instant t) is a value in $\R$????
        defined inductively as follows

        % The semantics of the variable symbols in terms are given by
        \begin{itemize}
            \item $\imodel{\IdL}{x} = \nu(x)(0)$
            \item $\imodel{\IdL}{\D{x}}=\nu(\D{x})(0)$
            \item $\imodel{\IdL}{f(\range{\istrm{1}}{\istrm{k}})} = $ for function symbol $f$
            \item $\imodel{\IdL}{\astrm+\bstrm} = \imodel{\IdL}{\astrm} + \imodel{\IdL}{\bstrm}$
            \item $\imodel{\IdL}{\astrm\cdot\bstrm} = \imodel{\IdL}{\astrm} \cdot \imodel{\IdL}{\bstrm}$
            \item $\imodel{\IdL}{\D{(\astrm)}}\nu = \sum_{x\in\allvars} \nu(\D{x})\frac{\partial\imodel{\IdL}{\astrm}}{\partial x}(\nu)$ syntactic (total) derivation, common derivation rules, gives new term, $\astrm$ must not contain $\xtau$
        \end{itemize}
        Cannot define the derivative of delayed symbols

        The semantic of the new symbol $\xtau$ depends on the context in which the term occures:
        \begin{itemize}
            \item in a hybrid program: $\imodel{\I}{\xtau} = \imodel[\nu]{}{x(t-\tau)} = \nu(x)(-\tau)\in\R$
            \item in a formula $\xtau\in\statespace$: \begin{equation}
                % FIXME: rechte seite noch nicht korrekt
                \imodel[]{}{\phi(\xtau)} =
                \{\nu\in\states : \lforall{t\in[-\tau,0]}{\phi(\nu(x)(t))} \}
            \end{equation}
            with uniform substitution: $\sigma=\{\xtau\rightarrow\theta_0\}$
        \end{itemize}

        Meaning differential symbol: defined by state, since time derivative may not be defined in isolated point (different to ODE, where isolated state=value in $\R$)
        Along a solution of a DDE $\varphi:[0,r]\rightarrow\states$ (continous differentiable), the differential symbols are interpreted as time derivatives, $r>0$ at any $\zeta\in[0,r]$, meaning of symbol is rate of change of value of $x$ over time
        \begin{equation}
            % TODO: replace \DD with Andres command
            \imodel{\IdL}{\D{x}}\varphi(\zeta)=\varphi(\zeta)(\D{x})(0)\defeq\DD{\varphi(t)(x)(0)}{t}(\zeta) = \DD{\imodel{\IdL}{x}\varphi(t)}{t}(\zeta)
        \end{equation}
        if $r=0$
        and what if there is no ODE/DDE given: in a given state should also be real value
        state assigns real values to all symbols, also differential symbols $\nu(\D{x}=\imodel{\IdL}{f(x)}\nu$
        in initial state an arbitray value is allowed, will then sync with equation to fullfil $\varphi(\zeta)(\D{x})=\imodel{\IdL}{f(x)}\varphi(r)$

        Like for ODE case, only use last value given in state. Since in $t=0$ could be incontinuity we cannot use history to define derivative.

        \begin{lemma}[Differential Lemma]

        \end{lemma}

        In the precondition, no values are associated to the differential symbols. In general, the initial function is only piecewise continuous.
        Since for later time instances, the values of the differential symbols derive from the DDE, they become (locally) smooth function.

    \end{definition}

    When we write $x$ we mean $x(t)$.

    \begin{definition}[Semantics of (\dL) formulae]
        \label{def:semantic-formulae}

        semantics of (\dL) formula $\asfml$ with set of states $\states$ is the subset of states $\imodel{\IdL}{\asfml}\subset\states$ in which $\asfml$ is true. this set is defined inductively by

        \begin{itemize}
            % TODO: replace : in set by \with
            \item $\imodel{\IdL}{\asfml\geq\bsfml} = \{\nu\in\states : \imodel{\IdL}{\asfml}\geq\imodel{\IdL}{\bsfml}\}$
            \item $\imodel{\IdL}{p(\range{\istrm{1}}{\istrm{k}})} = \{\nu\in\states : \}$
            \item $\imodel{\IdL}{\contextapp{C}{\asfml}} = $
            \item $\imodel{\IdL}{\lnot\asfml} = \scomplement{(\imodel{\IdL}{\asfml})} = \states\setminus\imodel{\IdL}{\asfml}$
            \item $\imodel{\IdL}{\asfml\land\bsfml} = \imodel{\IdL}{\asfml}\cap\imodel{\IdL}{\bsfml}$
            \item $\imodel{\IdL}{\lforall{x}{\asfml}} = \{\nu\in\states \with \modif{\nu}{x}{r}\in\imodel{\IdL}{\asfml} \text{ for all } r\in\R \}$
            \item $\imodel{\IdL}{\lexists{x}{\asfml}} = \{\nu\in\states \with \modif{\nu}{x}{r}\in\imodel{\IdL}{\asfml} \text{ for some } r\in\R \}$
            \item $\imodel{\IdL}{\dbox{\asprg}{\asfml}} = \{\nu\in\states \with \omega\in\imodel{\IdL}{\asfml} \text{ for all $\omega$ such that} (\nu,\omega)\in\imodel{\IdL}{\asprg}\}$
            \item $\imodel{\IdL}{\ddiamond{\asprg}{\asfml}} = \{\nu\in\states \with \omega\in\imodel{\IdL}{\asfml} \text{ for some $\omega$ such that} (\nu,\omega)\in\imodel{\IdL}{\asprg}\}$
        \end{itemize}
        if formula $\asfml$ is true in state $\nu$ we write $\nu\models\asfml$. It is called valid, written as $\models\asfml$ iff $\asfml$ is true in all states.

    \end{definition}


        With the semantics of terms if follows for the meaning of $\dbox{\asprg}{\phi}$, that $\phi$ must only hold up to time $\tau$ before leaving the \HP $\asprg$. It is possible, that $\phi$ was not verified before, while \textit{executing} the \HP.

        However when we apply the Rule of steps, we get the validity of $\phi$ for the entire trace.

        % TODO: is it better to only have xtau and not choice? What if both mentioned?
        in formulae (such as safety condition or evolution constraint), we have two possibilities: only value at current time instant ($x$) or for entire last $\tau$ time $\xtau$

        $\dbox{}{}$ and $\ddiamond{}{}$ only refer to last state and not intermediate states, as \dTL does.


    \begin{definition}[Transition semantics of \HPs]
        \label{def:semantic-HP}

         binary reachability relation $\iaccessibility(\asprg)\subseteq\states\times\states$. Since, with respect to \dL, the state space has been replaced, we need to redefine the semantics:
        \begin{itemize}
            % TODO: () for iaccessibility
            \item $\iaccessibility{a} = $
            \item $\iaccessibility{\hupdate{\humod{x}{\astrm}}}$
            \item $\iaccessibility{\Dupdate{\Dumod{\D{x}}{\astrm}}} $
            \item $\iaccessibility{\htest{\bsfml}}$
            \item $\iaccessibility{\hchoice{\asprg}{\bsprg}} = \hchoice{\iaccessibility{\asprg}}{\iaccessibility{\bsprg}}$
            \item $\iaccessibility{\asprg;\bsprg} $
            \item $\iaccessibility{\hrepeat{\asprg}} = \hrepeat{(\iaccessibility{\asprg})} = \cupfold_{n\in\N}\iaccessibility{\asprg^n}$ with $\asprg^{n+1}\equiv (\asprg^n;\asprg)$ and $\asprg^0\equiv \htest{\ltrue}$
            \item $\iaccessibility{\hevolvein{\D{x}=\astrm}{\bsfml}}$
        \end{itemize}

    \end{definition}

        The transition semantic of a hybrid program $\asprg$ is inductively given by a binary

        The \emph{discrete assignment} does not rewrite history, but changes only the value at the current time instant:
        \begin{equation}
            \iaccessibility(\hupdate{\humod{x}{\theta}}) =
                \left\{(\nu,\omega): \omega = \nu \text{ except }
                \omega(x) = \left(s\mapsto\begin{cases}
                    \imodel{\I}{\theta(t)} & s=0\\
                    \nu(s) & s\in[-\tau,0)
                \end{cases}\right)\right\}
        \end{equation}
        This assignment is the actual reason why we need to consider piecewise continuous evolutions.

        No functional assignment, which would essentially allow to rewrite history

        %TODO: super dense time: multiple assignments, only consider last assignment

        Using the extended syntax, we can write down both a delay differential equation and an ordinary differential equation in the form $\D{x}=\theta$, where $\theta=f(x,\xtau)$ with a polynomial $f$.
        \begin{equation}
            \iaccessibility(\hevolvein{\D{x}=\theta}{\ivr}) = \left\{
                (\varphi(0),\varphi(s))\,:\,\lforall{0\leq t\leq s}{\varphi(t)\models \D{x}=\theta\,\wedge\,\varphi(t)(0)\models\ivr}\text{ for a solution } \varphi:[0,s]\rightarrow\states \right\}
        \end{equation}
        As a solution, $\varphi$ needs to fulfill
        \begin{equation}
            \varphi(t)(\D{x})(0) \defeq \DD{\varphi(\zeta)(x)(0)}{\zeta}(t) \stackrel{!}{=} \imodel[]{}{\theta}\varphi(t)
        \end{equation}
        Along a DDE/ODE, values of differential symbols coincide with time derivative of value of corresponding variable
        Remember that a $\xtau$ mentioned in $\theta$ here means $\varphi(t)(x)(-\tau)$.
        And so needs $\ivr$ always just hold at the current time instant (and not over the entire interval $[-\tau,0]$). The same case for $\ptest\psi$.

        \begin{lemma}[Differential Lemma]
            lecture notes L10.20
            needed for DI proof
            no changes, except for rewriting $\varphi(t)(x)\rightarrow\varphi(t)(x)(0)$
        \end{lemma}

        % TODO: what about [a;b]p. is [a][b]p correct?
