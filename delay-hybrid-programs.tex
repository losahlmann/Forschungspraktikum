\chapter{Hybrid Programs with DDEs}\label{hybrid-programs-with-ddes}

We extent hybrid programs (\HPs) and formulae of classic \dL with syntax, semantics, axiomatization and proof rules which allow to deal with Delay Differential Equations.
%Is a super set, \dL is a fragment

Similiar to first-order logic and essentially as an extension of dL we define delay differential logic

\cite{Platzer12Complete,Platzer15Uniform}

\section{Example}
    \label{example-hp-cars}
    To motivate the need of being able to treat Delayed Differential Equations in hybrid programs, we present some examples.

    \subsection{Leading and Following Car}

    \subsection{Network Induced Delay in Control Loops}

\section{Syntax}
    \label{sec:syntax}

    The syntax of terms, formula, hp defined inductively by grammar in BNF.

    Let $\allvars$ be the set of \emph{all variables} and $\diffvars\defeq\{\D{x} \with x\in\allvars\}$ the corresponding set of \emph{differential symbols}.
    %and set of \emph{delayed variables} $\delayedvars\defeq\{\xtau \with x\in\allvars\}$

    The variables will be usually denoted $x,y,z\in\allvars$, with their differential symbols $\D{x},\D{y},\D{z}\in\diffvars$.

    Function symbols $f,g,h$, constant symbols $a,b,c$ and predicate symbols $p,q,r$ are as in first-order logic (cf. Section \ref{sec:first-order-logic}).

    % FIXME: what are program constants?
    %program constants $ $, may be in $\rationals$

    \begin{definition}[Terms]\label{def:syntax-terms}
        \emph{Terms} are defined by the following grammar, extending classical \dL with a symbol for a \textbf{delayed variable}:
        \begin{equation}
            \astrm,\bstrm \Coloneqq
                %x \mid
                % FIXME: make -\tau standard
                \xtau[s] \mid
                \Dxtau[s] \mid
                c \mid
                f(\range{\istrm{1}}{\istrm{n}}) \mid
                \astrm+\bstrm \mid
                \astrm\cdot\bstrm \mid
                % FIXME: is term' allowed? diff inv is only a FOLR formula? even for dL valid?
                \D{(\astrm)}
        \end{equation}
        where $x\in\allvars,\D{x}\in\diffvars$ and $f$ is a function symbol of arity $k$.
        The symbol $c$ defines a rational number constant.
        All terms implicitely depend on a time parameter $t\leq 0$, written as $\astrm(t)$. When $t=0$ we abbreviate to $\astrm$. The variable symbol $x$ is the only which allows explicitely mentioning this parameter. It is spelled slightly differently as $\xtau[-t]$. Again, for $\xtau[0]$ we write $x$.
        $x=x[0]$
        parameter is inherited

        % TODO: subtraction and division in terms

        %The symbol $x$ is only allowed in the right hand side of a DDE and in evolution domain constraints, not in other formulas. The latter may only contain $\xtau$.
    \end{definition}

    % where $x$ and where $\xtau$?
    The grammar defining hybrid programs is the same as for classical \dL and shown here for completeness.

    \begin{definition}[Hybrid program]\label{def:syntax-HP}
        \emph{Hybrid programs} (\HP) are defined by
        % TODO: first-order logic of real arithmetic formulas include \xtau?
        \begin{equation}
            \asprg, \bsprg \Coloneqq
                a \mid
                \hupdate{\humod{x}{\astrm}} \mid
                \Dupdate{\Dumod{\D{x}}{\astrm}} \mid
                \htest{\asfmlfolR} \mid
                \hchoice{\asprg}{\bsprg} \mid
                % TODO: replace ; in HPs
                \asprg;\bsprg \mid
                \hrepeat{\asprg} \mid
                \hevolvein{\D{x}=\astrm}{\ivr}
        \end{equation}
        % TODO: program constant
        where $\asprg, \bsprg$ denote \HPs, with a variable $x$, a term $\astrm$ (possibly containing $x$ or $\xtau$) and $\ausprg$ a program constant.
        The formula $\asfmlfolR$ is of first-order logic of real arithmetic (\FOLR$(\allvars)$).
    \end{definition}

    % TODO: FOLR is subset of ddL formulae

    same grammar as in \cite{Platzer15Uniform}
    difference to \dL, refer to Section \ref{sec:dynamic-semantics} for meaning of the following, different meaning for formulae

    assignment, discretely at an instant of time
    test of formula in current state
    nondeterministic choice
    sequential composition
    nondeterministic repetition
    delay differential equation with restricted evolution, due to domain constraint $\bsfml$, follow arbitrary amount of time
    ODE still possible



    \begin{definition}[\ddL formula]\label{def:syntax-formula}
        The \emph{formulas} of \emph{delay differential dynamic logic} (\ddL) are defined by
        \begin{align}
            \asfml,\bsfml \Coloneqq
                % TODO: better abbreviated notation for \delay, make forall only appear in semantics rhs
                &\holdssince{T}{\astrm\geq\bstrm} \mid
                \holdssince{T}{p(\range{\istrm{1}}{\istrm{k}})} \mid\\
                &\contextapp{C}{\asfml} \mid
                \lnot\asfml \mid
                \asfml\land\bsfml \mid
                \lforall{x}{\asfml} \mid
                \lexists{x}{\asfml} \mid
                \dbox{\asprg}{\asfml} \mid
                \ddiamond{\asprg}{\asfml}
        \end{align}
        with terms $\astrm,\bstrm,\range{\istrm{1}}{\istrm{k}}$,
        % TODO: replace with command for predicate symbols, quantifier symbol
        a predicate symbol $p$, a quantifier symbol $C$, a variable $x$, and a \HP $\asprg$.
        
        % TODO: need = in formulas ?
        Other operators, such as $>,\leq,<,\lor,\limply,\lbisubjunct$ can be derived from $\land,\lnot$ and are hence not explicitely mentioned in the grammar.

        modal formula $\dbox{\asprg}{\asfml}$ : $\asfml$ holds in the state after all runs of $\asprg$, dual: there is a run
        % TODO: what is a quantifier symbol? (-> US paper)
        quantifier symbols $C$, with formula as argument are higher order predicate symbols and bind the variables of $\asfml$

        The delay $\tau$ is a symbolic constant related to the history duration induced by the occurence of a delay-differnetial equation. Its value is set by proof rules.
    \end{definition}

    When terms do not depend on quantified parameter, can omit writing down forall in formula

\section{Dynamic Semantics}
    \label{sec:dynamic-semantics}

    Following the remark to the solution of a DDE (cf. Section \ref{sec:definition-of-solution}), we augment the \emph{state space} in \dL to $\statespace$, the set of piecewise continuous functions on $\delayinterval$ (its support), as defined in Definition \ref{def:piecewise-continuous}.

    This means that a variable remembers a limited part of its evolution history, what demands hence an implicit notion of a underlying time.

    We denote by $\states$ the \emph{set of states}. A \emph{state} $\asstate\in\states$ is a mapping
    \begin{equation}
        \asstate \from \allvars\cup\diffvars \to \statespace
    \end{equation}
    which assigns a \emph{history} (function) to each variable and differential symbol.

    By $\modif{\asstate}{x}{r}$ we denote the state which is equal to state $\asstate$, except for the value of the variable $x$ which is set to $r\in\statespace$.

    % FIXME: modification of x in state and general specification of pw function associated to x
    %at the time $t=0$. The value of $x$ for the time before does not change.

    % TODO: Abgrenzung zu Trace Semantics
    % The temporal character of delay differential equations (they depend on their own temporal evolution with limited horizon) suggests the introduction of trace semantics.
    %
    % However, we go the way of introducing transition semantics with an augmented state space.

    \begin{definition}[Semantics of terms]\label{def:sematic-terms}
        The \emph{semantics} of a term $\astrm$ in the state $\asstate\in\statespace$ (at time instant $t$) is a value in $\R$ and defined inductively as follows:
        \begin{enumerate}
            % FIXME: display I as superscript
            \item $\ivaluation{\IddL}{\xtau[s]} = \asstate(x)(s)$ for a variable $x\in\allvars$
            % FIXME: need Cpw for derivatives or only \R?
            \item $\ivaluation{\IddL}{\Dxtau[s]} = \asstate(\D{x})(s)$ for a differential symbol $\D{x}\in\diffvars$
            \item $\ivaluation{\IddL}{c} = \interpret[c]$ for a constant $c$
            \item $\ivaluation{\IddL}{f(\range{\istrm{1}}{\istrm{n}})} = \interpret[f](\range{\ivaluation{\IddL}{\istrm{1}}}{\ivaluation{\IddL}{\istrm{n}}})$ for a function symbol $f$
            \item $\ivaluation{\IddL}{\astrm+\bstrm} = \ivaluation{\IddL}{\astrm} + \ivaluation{\IddL}{\bstrm}$
            \item $\ivaluation{\IddL}{\astrm\cdot\bstrm} = \ivaluation{\IddL}{\astrm} \cdot \ivaluation{\IddL}{\bstrm}$
            % FIXME: derivation of terms?
            \item $\ivaluation{\IddL}{\D{(\astrm)(s)}} = \displaystyle\sum_{x\in\allvars} \asstate(\D{x})(s)\frac{\partial\ivaluation{\IddL}{\astrm}}{\partial x}(\asstate)$
        \end{enumerate}
        where $s\in [-T,0]$.
        The  syntactic (total) derivation, defined in \ref{def:derivation}, gives new term
    \end{definition}
        % TODO: mention 'interpretation' for semantics.
        % FIXME: interpretation of $f$ is a smooth function


    % TODO: total derivative operator for terms
    \begin{definition}[Derivation]\label{def:derivation}
        common derivation rules
    \end{definition}

    % The semantic of the new symbol $\xtau$ depends on the context in which the term occures:
    % \begin{enumerate}
    %     \item in a hybrid program: $\imodel{\IddL}{\xtau} = \imodel{\IddL}{x(t-\tau)} = \nu(x)(-\tau)\in\R$
    %     \item in a formula $\xtau\in\statespace$: \begin{equation}
    %         % FIXME: rechte seite noch nicht korrekt
    %         \imodel[]{}{\phi(\xtau)} =
    %         \{\nu\in\states : \lforall{t\in[-\tau,0]}{\phi(\nu(x)(t))} \}
    %     \end{equation}
    %     with uniform substitution: $\sigma=\{\xtau\rightarrow\theta_0\}$
    % \end{enumerate}

    Meaning differential symbol: defined by state, since time derivative may not be defined in isolated point (different to ODE, where isolated state=value in $\R$)

    Along a solution of a DDE $\varphi:[0,r]\rightarrow\states$ (continous differentiable), the differential symbols are interpreted as time derivatives, $r>0$ at any $\zeta\in[0,r]$, meaning of symbol is rate of change of value of $x$ over time
    \begin{equation}
        % TODO: replace \DD with Andres command
        \imodel{\IddL}{\D{x}}\varphi(\zeta)
            = \varphi(\zeta)(\D{x})(0)
            \defeq \DD{\varphi(t)(x)(0)}{t}(\zeta)
            = \DD{\imodel{\IddL}{x}\varphi(t)}{t}(\zeta)
    \end{equation}
    if $r=0$
    and what if there is no ODE/DDE given: in a given state should also be real value
    state assigns real values to all symbols, also differential symbols $\nu(\D{x}=\imodel{\IddL}{f(x)}\nu$
    in initial state an arbitray value is allowed, will then sync with equation to fullfil $\varphi(\zeta)(\D{x})=\imodel{\IddL}{f(x)}\varphi(r)$
    initial value $\asstate(\D{x})$ may not be compatible with derivative
    final values coincide

    Like for ODE case, only use last value given in state. Since in $t=0$ could be incontinuity we cannot use history to define derivative.

    \begin{lemma}[Differential Lemma]

    \end{lemma}

    In the precondition, no values are associated to the differential symbols. In general, the initial function is only piecewise continuous.
    Since for later time instances, the values of the differential symbols derive from the DDE, they become (locally) smooth function.

    

    When we write $x$ we mean $x(t)$.

    \begin{definition}[Semantics of (\ddL) formulae]\label{def:semantic-formulae}
        The semantics of a \ddL formula $\asfml$ is the subset of all states $\imodel{\IddL}{\asfml}\subseteq\states$ in which $\asfml$ is true. This set is given inductively by
        % TODO: mention interpretation I
        % FIXME: wahta is difference between \imodel and \ivaluation?
        \begin{enumerate}
            % TODO: replace : in set by \with
            \item $\imodel{\IddL}{\holdssince{T}{\asfml\geq\bsfml}} = \left\{\asstate\in\states \with \holdssince{T}{\ivaluation{\IddL}{\asfml(s)}\geq\ivaluation{\IddL}{\bsfml(s)}}\right\}$
            \item $\imodel{\IddL}{\holdssince{T}{p(\range{\istrm{1}}{\istrm{k}})}} = \left\{\asstate\in\states \with \holdssince{T}{\left(\range{\imodel{\IddL}{\istrm{1}(s)}}{\imodel{\IddL}{\istrm{k}(s)}}\right)\in\interpret[p]}\right\}$
            \item $\imodel{\IddL}{\contextapp{C}{\asfml}} = \interpret[C]\left(\imodel{\IddL}{\asfml}\right)$ for a quantifier symbol $C$
            \item $\imodel{\IddL}{\lnot\asfml} = \scomplement{\left(\imodel{\IddL}{\asfml}\right)} = \states\setminus\imodel{\IddL}{\asfml}$
            \item $\imodel{\IddL}{\asfml\land\bsfml} = \imodel{\IddL}{\asfml}\cap\imodel{\IddL}{\bsfml}$
            \item $\imodel{\IddL}{\lforall{x}{\asfml}} = \{\asstate\in\states \with \modif{\asstate}{x}{y}\in\imodel{\IddL}{\asfml} \text{ for all } y\in\statespace \}$
            \item $\imodel{\IddL}{\lexists{x}{\asfml}} = \{\asstate\in\states \with \modif{\asstate}{x}{y}\in\imodel{\IddL}{\asfml} \text{ for some } y\in\statespace \}$
            \item $\imodel{\IddL}{\dbox{\asprg}{\asfml}} = \{\asstate\in\states \with \omega\in\imodel{\IddL}{\asfml} \text{ for all $\omega$ such that} (\asstate,\omega)\in\imodel{\IddL}{\asprg}\}$
            \item $\imodel{\IddL}{\ddiamond{\asprg}{\asfml}} = \{\asstate\in\states \with \omega\in\imodel{\IddL}{\asfml} \text{ for some $\omega$ such that} (\asstate,\omega)\in\imodel{\IddL}{\asprg}\}$
        \end{enumerate}
        That formula $\asfml$ is true in state $\asstate$ under interpretation $\interpret$ can also be written as $\interpret,\asstate\models\asfml$. The formula is called valid, written as $\models\asfml$, iff $\asfml$ is true in all states under all interpretations.
    \end{definition}

    interpretation of predicate symbol, arity n: relation $I(p)\subseteq\R^n$
    interpretation of a quantifier symbol: functional $I(C):M\subseteq\states\to P(\states)$ maps subsets of states to subsets of states

    With the semantics of terms if follows for the meaning of $\dbox{\asprg}{\phi}$, that $\phi$ must only hold up to time $\tau$ before leaving the \HP $\asprg$. It is possible, that $\phi$ was not verified before, while \emph{executing} the \HP.

    However when we apply the Rule of steps, we get the validity of $\phi$ for the entire trace.

    % TODO: is it better to only have xtau and not choice? What if both mentioned?
    in formulae (such as safety condition or evolution constraint), we have two possibilities: only value at current time instant ($x$) or for entire last $\tau$ time $\xtau$

    $\dbox{}{}$ and $\ddiamond{}{}$ only refer to last state and not intermediate states, as \dTL does.

    Since, with respect to \dL, the state space has been replaced, we need to redefine the semantics.
    
    \begin{definition}[Transition semantics of \HPs]\label{def:semantic-HP}
        The interpretation of a \HP is given by a binary \emph{reachability relation} $\ireachability{\IddL}{\asprg}\subseteq\states\times\states$ between states:
        \begin{enumerate}
            \item $\ireachability{\IddL}{a} = \interpret[a]$ for a program constant $a$
            \item $\ireachability{\IddL}{\hupdate{\humod{x}{\astrm}}} =
                \left\{(\asstate,\bsstate)\with \bsstate = \asstate \text{ except }
                \bsstate(x) = \left(s\mapsto\begin{cases}
                    \imodel{\IddL}{\theta(s)} & s=0\\
                    \asstate(s) & s\in[-T,0)
                \end{cases}\right)\right\}$
            \item $\ireachability{\IddL}{\Dupdate{\Dumod{\D{x}}{\astrm}}} =
                \left\{(\asstate,\bsstate)\with \bsstate = \asstate \text{ except }
                \bsstate(\D{x}) = \left(s\mapsto\begin{cases}
                    \imodel{\IddL}{\theta(s)} & s=0\\
                    \asstate(s) & s\in[-T,0)
                \end{cases}\right)\right\}$
            \item $\ireachability{\IddL}{\htest{\asfmlfolR}} = \left\{(\asstate,\asstate) \with \asstate\in\imodel{\IddL}{\asfmlfolR} \right\}$
            \item $\ireachability{\IddL}{\hchoice{\asprg}{\bsprg}} = \hchoice{\ireachability{\IddL}{\asprg}}{\ireachability{\IddL}{\bsprg}}$
            \item $\ireachability{\IddL}{\asprg;\bsprg} = \left\{ (\asstate,\bsstate) \with (\asstate,\csstate)\in\ireachability{\IddL}{\asprg}, (\csstate,\bsstate)\in\ireachability{\IddL}{\bsprg} \right\}$
            \item $\ireachability{\IddL}{\hrepeat{\asprg}} %= \hrepeat{(\ireachability{\IddL}{\asprg})}
                = \displaystyle\cupfold_{n\in\N}\ireachability{\IddL}{\asprg^n}$ with $\asprg^{n+1}\equiv (\asprg^n;\asprg)$ and $\asprg^0\equiv \htest{\ltrue}$
            \item $\ireachability{\IddL}{\hevolvein{\D{x}=\astrm}{\ivr}} = \left\{
                (\asstate,\bsstate) \with
                \lforall{t\in[0,r]}{\varphi(t)\in\imodel{\IddL}{\hevolve{\D{x}=\astrm}\land\ivr}}
                \text{ and } \asstate=\varphi(0) \text{ on } \scomplement{\{\D{x}\}} \text{ and } \bsstate=\varphi(r))
                \right\}$, i.e. there exists a $r\geq 0$ and a function $\varphi\from [0,r]\to\states$, which fulfills $\varphi(t)(\D{x})(0) \defeq \DD{\varphi(\zeta)(x)(0)}{\zeta}(t) \stackrel{!}{=} \imodel{\iconcat[state=\varphi(t)]{\IddL}}{\theta}$
        \end{enumerate}
    \end{definition}

    $\varphi$ solves the DDE and satisfies $\ivr$ in each time instant
    if $r=0$: 

    For the \emph{discrete assignment}, we only allow the values at the current time instant to be changed. A functional assignment would essentially allow to rewrite history, which is not permitted.

    This assignment is the actual reason why we need to consider piecewise continuous evolutions.

    

    %TODO: super dense time: multiple assignments, only consider last assignment

    Using the extended syntax, we can write down both a delay differential equation and an ordinary differential equation in the form $\D{x}=\theta$, where $\theta=f(x,\xtau)$ with a polynomial $f$.

    Along a DDE/ODE, values of differential symbols coincide with time derivative of value of corresponding variable
    Remember that a $\xtau$ mentioned in $\theta$ here means $\varphi(t)(x)(-\tau)$.
    And so needs $\ivr$ always just hold at the current time instant (and not over the entire interval $[-\tau,0]$). The same case for $\ptest\psi$.

    \begin{lemma}[Differential Lemma]
        lecture notes L10.20
        needed for DI proof
        no changes, except for rewriting $\varphi(t)(x)\rightarrow\varphi(t)(x)(0)$
    \end{lemma}

    % TODO: what about [a;b]p. is [a][b]p correct?

    \begin{definition}[History Horizon]
        history horizon of a \ddL formula, depends on all occurences of $\xtau[s]$
        T in forall: comp, pred
        minimum of T in forall parts of subformulas: quantifier, not and
        forall, exists?
        modalities: max $\tau$ in DDE and of formula
    \end{definition}

    % TODO: feasible history horizon for a HP
