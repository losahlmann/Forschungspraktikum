\chapter{Hybrid Programs with DDEs}\label{hybrid-programs-with-ddes}

We extent hybrid programs (\HPs) and formulae of classical \dL with syntax, semantics, axiomatization and proof rules which allow to deal with Delay Differential Equations.
%Is a super set, \dL is a fragment
Call obtained \dHPs and \ddL.

Similiar to first-order logic and essentially as an extension of dL we define delay differential logic

\cite{Platzer12Complete,Platzer15Uniform}

\section{Example}
    \label{example-hp-cars}
    To motivate the need of being able to treat Delayed Differential Equations in hybrid programs, we present some examples.

    \subsection{Leading and Following Car}

    \subsection{Network Induced Delay in Control Loops}

\section{Syntax}
    \label{sec:syntax}

    The syntax of \ddL terms, formulae as well as of \dHPs is defined inductively by a grammar in Backus-Naur-form (BNF).

    Let $\allvars$ be the set of \emph{all variables} and $\diffvars\defeq\{\D{x} \with x\in\allvars\}$ the corresponding set of \emph{differential symbols}.
    %and set of \emph{delayed variables} $\delayedvars\defeq\{\xtau \with x\in\allvars\}$

    We will usually denote variables by $x,y,z\in\allvars$ and their differential symbols by $\D{x},\D{y},\D{z}\in\diffvars$.

    Function symbols $f,g,h$, constant symbols $a,b,c$ and predicate symbols $p,q,r$ are as in first-order logic (cf. Section \ref{sec:first-order-logic}).

    % FIXME: what are program constants?
    %program constants $ $, may be in $\rationals$

    \begin{definition}[Terms]\label{def:syntax-terms}
        \emph{Terms} are defined by the following grammar, extending \dL with symbols for \emph{delayed variables}:
        \begin{equation*}
            \astrm,\bstrm \Coloneqq
                \xtau[s] \mid
                \Dxtau[s] \mid
                % TODO: maybe dont need x[c], only with s and use t(s) with specified s, as in DDE and extra x[0]=x
                \xtau[b] \mid
                \Dxtau[b] \mid
                c \mid
                f(\range{\istrm{1}}{\istrm{k}}) \mid
                \astrm + \bstrm \mid
                \astrm \cdot \bstrm \mid
                % FIXME: is term' allowed? diff inv is only a FOLR formula? even for dL valid?
                \D{(\astrm)}
        \end{equation*}
        where $x\in\allvars,\D{x}\in\diffvars$ and $f$ is a function symbol of arity $k$.
        The symbol $c$ defines a rational number constant and $b\in\Q_{\leq 0}$.
        All terms implicitely depend on a time parameter $s\in\R_{\leq 0}$, written as $\astrm(s)$. When $s=0$ we abbreviate the notation to $\astrm$.
        The variable symbol $x$ and the differential symbol $\D{x}$ are the only which allow explicitely mentioning this parameter. It is spelled slightly differently as $\xtau[s]$ and $\Dxtau[s]$, respectively. Note that $s\notin\allvars\cup\diffvars$. It is a special variable.
        Again, for $\xtau[0]$ we write $x$ and $\D{x}$ for $\Dxtau[0]$.
        Writing $\astrm(-\tau)$ means that all occurences of $s$ in $\astrm$ have been replaced with $-\tau$.

        parameter is inherited

        % TODO: subtraction and division in terms

        %The symbol $x$ is only allowed in the right hand side of a DDE and in evolution domain constraints, not in other formulas. The latter may only contain $\xtau$.
    \end{definition}

    \begin{example}
        Let us consider the \ddL term
        \begin{equation}
            \astrm(s) = \underbrace{\xtau[s]}_{\text{var}} + \underbrace{\xtau}_{\text{const}}.
        \end{equation}
        Setting $s=-1$ leads to
        \begin{equation}
            \astrm(-1) = \xtau[-1] + \xtau.
        \end{equation}
    \end{example}

    The grammar defining \emph{delayed hybrid programs} is the same as for classical \HPs (cf. \cite{Platzer15Uniform}) and is shown here for completeness.

    \begin{definition}[(Delay) Hybrid Programs]\label{def:syntax-HP}
        \emph{(Delay) Hybrid programs} (\dHPs) are defined by
        % TODO: first-order logic of real arithmetic formulas include \xtau?
        \begin{equation*}
            \asprg, \bsprg \Coloneqq
                a \mid
                \hupdate{\humod{x}{\astrm(0)}} \mid
                \Dupdate{\Dumod{\D{x}}{\astrm(0)}} \mid
                \htest{\asfmlfolR} \mid
                \hchoice{\asprg}{\bsprg} \mid
                % TODO: replace ; in HPs
                \asprg;\bsprg \mid
                \hrepeat{\asprg} \mid
                \hevolvein{\D{x}=\astrm(-\tau)}{\ivr}
        \end{equation*}
        % TODO: program constant
        where $\asprg, \bsprg$ denote \dHPs, with a variable $x$, a term $\astrm$ (possibly containing $x$ or $\xtau$) and $\ausprg$ a program constant.
        The formula $\asfmlfolR$ is of first-order logic of real arithmetic \FOLR$(\allvars)$, containing only normal variable symbols $\allvars$.
        Note: $s\notin\asprg$.
        Syntax only allows autonomous DDEs.
    \end{definition}

    % TODO: FOLR is subset of ddL formulae

    The difference between classical \HPs (in the sense of ...) and \dHPs is not syntactically, but only given by their semantics.

    refer to Section \ref{sec:dynamic-semantics} for meaning of the following, different meaning for formulae

    assignment, discretely at an instant of time
    test of formula in current state
    nondeterministic choice
    sequential composition
    nondeterministic repetition
    delay differential equation with restricted evolution, due to domain constraint $\bsfml$, follow arbitrary amount of time
    DDE with delay tau, term has only $x$ and $\D{x}$ with constant nor var $s$
    ODE still possible


    \begin{definition}[\ddL Formulas]\label{def:syntax-formula}
        The \emph{formulae} of \emph{delay differential dynamic logic} (\ddL) are defined by
        \begin{align*}
            \asfml,\bsfml \Coloneqq{}& % fixes missing space
                % TODO: better abbreviated notation for \holdssince, make forall only appear in semantics rhs
                \astrm\geq\bstrm \mid
                p(\range{\istrm{1}}{\istrm{k}}) \mid
                \contextapp{C}{\asfml} \mid
                \lnot\asfml \mid
                \asfml\land\bsfml \mid\\
                &\holdssince{T}{\asfml(s)} \mid
                \lforall{x}{\asfml} \mid
                \lexists{x}{\asfml} \mid
                \dbox{\asprg}{\asfml} \mid
                \ddiamond{\asprg}{\asfml}
        \end{align*}
        with \ddL terms $\astrm,\bstrm,\range{\istrm{1}}{\istrm{k}}$,
        a predicate symbol $p$, a quantifier symbol $C$, a variable $x$, and a \dHP $\asprg$.
        
        % TODO: need = in formulas ?
        Other operators
        $\sim$ for $=,<,\leq,>,\geq$, such as $\lor,\limply,\lbisubjunct$ can be derived from $\land,\lnot$ and are hence not explicitely mentioned in the grammar.

        modal formula $\dbox{\asprg}{\asfml}$ : $\asfml$ holds in the state after all runs of $\asprg$, dual: there is a run
        % TODO: what is a quantifier symbol? (-> US paper)
        quantifier symbols $C$, with formula as argument are higher order predicate symbols and bind the variables of $\asfml$

        The quantifiers $\forall$ and $\exists$ quantify over $\statespace$.

        The symbol $T$ is a symbolic constant related to the history duration induced by the occurence of a delay-differnetial equation. Its value is set by proof rules.
    \end{definition}

    \FOLR formulae are a subset of \ddL.

    When terms do not depend on quantified parameter, can omit writing down forall in formula

\section{Dynamic Semantics}
    \label{sec:dynamic-semantics}

    Following the remark to the solution of a DDE (cf. Section \ref{sec:definition-of-solution}), we augment the \emph{state space} in \dL to $\statespace$, the set of piecewise continuous functions on $\delayinterval$ (its support), as defined in Definition \ref{def:piecewise-continuous}.

    This means that a variable remembers a limited part of its evolution history, what demands hence an implicit notion of a underlying time.

    We denote by $\states$ the \emph{set of states}. A \emph{state} $\asstate\in\states$ is a mapping
    \begin{equation}
        \asstate \from \allvars\cup\diffvars \to \statespace
    \end{equation}
    which assigns a \emph{history} (function) to each variable and differential symbol.

    By $\modif{\asstate}{x}{r}$ we denote the state which is equal to state $\asstate$, except for the value of the variable $x$ which is set to $r\in\statespace$.

    % FIXME: modification of x in state and general specification of pw function associated to x
    %at the time $t=0$. The value of $x$ for the time before does not change.

    % TODO: Abgrenzung zu Trace Semantics
    % The temporal character of delay differential equations (they depend on their own temporal evolution with limited horizon) suggests the introduction of trace semantics.
    %
    % However, we go the way of introducing transition semantics with an augmented state space.

    \begin{definition}[Semantics of terms]\label{def:sematic-terms}
        The \emph{semantics} of a term $\astrm$ in the state $\asstate\in\states$ (at time instant $t$) is a value in $\R$ and defined inductively as follows:
        \begin{enumerate}
            \item $\ivaluation{\IddL}{\xtau[s]} = \asstate(x)(s)$ for a variable $x\in\allvars$
            % FIXME: need Cpw for derivatives or only \R?
            \item $\ivaluation{\IddL}{\Dxtau[s]} = \asstate(\D{x})(s)$ for a differential symbol $\D{x}\in\diffvars$
            \item $\ivaluation{\IddL}{c} = \interpret[c]$ for a constant $c$
            \item $\ivaluation{\IddL}{f(\range{\istrm{1}}{\istrm{k}})} = \interpret[f](\range{\ivaluation{\IddL}{\istrm{1}}}{\ivaluation{\IddL}{\istrm{k}}})$ for a function symbol $f$
            \item $\ivaluation{\IddL}{\astrm+\bstrm} = \ivaluation{\IddL}{\astrm} + \ivaluation{\IddL}{\bstrm}$
            \item $\ivaluation{\IddL}{\astrm\cdot\bstrm} = \ivaluation{\IddL}{\astrm} \cdot \ivaluation{\IddL}{\bstrm}$
            % FIXME: derivation of terms with x'?
            \item $\ivaluation{\IddL}{\D{(\astrm)}}(s) = \displaystyle\sum_{x\in\allvars} \asstate(\D{x})(s)\frac{\partial\ivaluation{\IddL}{\astrm}}{\partial x}(s)$
        \end{enumerate}
        where $s\in [-T,0]$.
        The  syntactic (total) derivation, defined in \ref{def:derivation}, gives new term
    \end{definition}
        % TODO: mention 'interpretation' for semantics.
        % FIXME: interpretation of $f$ is a smooth function


    % TODO: total derivative operator for terms
    \begin{definition}[Derivation]\label{def:derivation}
        common derivation rules
        $\D{(\xtau[b])}=\Dxtau[b]$ need in premise $\D{x}$ on $[t+b,t]$
    \end{definition}

    % The semantic of the new symbol $\xtau$ depends on the context in which the term occures:
    % \begin{enumerate}
    %     \item in a hybrid program: $\imodel{\IddL}{\xtau} = \imodel{\IddL}{x(t-\tau)} = \nu(x)(-\tau)\in\R$
    %     \item in a formula $\xtau\in\statespace$: \begin{equation}
    %         % FIXME: rechte seite noch nicht korrekt
    %         \imodel[]{}{\phi(\xtau)} =
    %         \{\nu\in\states : \lforall{t\in[-\tau,0]}{\phi(\nu(x)(t))} \}
    %     \end{equation}
    %     with uniform substitution: $\sigma=\{\xtau\rightarrow\theta_0\}$
    % \end{enumerate}

    The meaning of a differential symbol: defined by state, 
    The time derivative of a variable may not be defined in isolated state, because it might have a discontinuity here and we cannot use its history (provided by the state) to define derivative.
    However, we can define a state local semantics for a differential $\D{(\astrm)}$.

    Like for ODE case, only use last value given in state. Since in $t=0$ could be incontinuity 

    chain rule for $\astrm(s)$
    $\asfml$ only mentions finitely many variables, finite sum
    $\ivaluation{\IddL}{\D{(\astrm)}}(s)$ is smooth as composition of smooth functions, derivatives exist

    Along a solution of a DDE $\varphi:[0,r]\rightarrow\states$ (continous differentiable), the differential symbols are interpreted as time derivatives, $r>0$ at any $\zeta\in[0,r]$, meaning of symbol is rate of change of value of $x$ over time
    \begin{equation}
        % TODO: replace \DD with Andres command
        \imodel{\IddL}{\D{x}}\varphi(\zeta)
            = \varphi(\zeta)(\D{x})(0)
            \defeq \DD{\varphi(t)(x)(0)}{t}(\zeta)
            = \DD{\imodel{\IddL}{x}\varphi(t)}{t}(\zeta)
    \end{equation}
    if $r=0$
    and what if there is no ODE/DDE given: in a given state should also be real value
    
    in initial state an arbitray value is allowed, will then sync with equation to fullfil $\varphi(\zeta)(\D{x})=\imodel{\IddL}{f(x)}\varphi(r)$
    initial value $\asstate(\D{x})$ may not be compatible with derivative
    final values coincide

    

    \begin{lemma}[Differential Lemma]

    \end{lemma}

    In the precondition, no values are associated to the differential symbols. In general, the initial function is only piecewise continuous.
    Since for later time instances, the values of the differential symbols derive from the DDE, they become (locally) smooth function.

    

    When we write $x$ we mean $x(t)$.

    \begin{definition}[Semantics of \ddL formulae]\label{def:semantic-formulae}
        The semantics of a \ddL formula $\asfml$ is the subset of all states $\imodel{\IddL}{\asfml}\subseteq\states$ in which $\asfml$ is true. This set is given inductively by
        % TODO: mention interpretation I
        % FIXME: what is difference between \imodel and \ivaluation?
        % terms: ivaluation, formula: imodel, programms: ireachability
        \begin{enumerate}
            % TODO: replace : in set by \with
            % FIXME: change ':' in sets to '|'
            % FIXME: use notation forall ... : ...
            % FIXME: *version for lforall without parentheses
            %\item $\imodel{\IddL}{\holdssince{T}{\astrm\geq\bstrm}} = \left\{\asstate\in\states \with \holdssince{T}{\ivaluation{\IddL}{\astrm(s)}\geq\ivaluation{\IddL}{\bstrm(s)}}\right\}$
            %\item $\imodel{\IddL}{\holdssince{T}{p(\range{\istrm{1}}{\istrm{k}})}} = \left\{\asstate\in\states \with \holdssince{T}{\left(\range{\imodel{\IddL}{\istrm{1}(s)}}{\imodel{\IddL}{\istrm{k}(s)}}\right)\in\interpret[p]}\right\}$
            \item $\imodel{\IddL}{\astrm(s)\geq\bstrm(s)} = \left\{\asstate\in\states \with \ivaluation{\IddL}{\astrm(s)}\geq\ivaluation{\IddL}{\bstrm(s)}\right\}$
            \item $\imodel{\IddL}{p(\range{\istrm{1}(s)}{\istrm{k}(s)})} = \left\{\asstate\in\states \with \left(\range{\ivaluation{\IddL}{\istrm{1}(s)}}{\ivaluation{\IddL}{\istrm{k}(s)}}\right)\in\interpret[p]\right\}$
            \item $\imodel{\IddL}{\contextapp{C}{\asfml}} = \interpret[C]\left(\imodel{\IddL}{\asfml}\right)$ for a quantifier symbol $C$
            \item $\imodel{\IddL}{\lnot\asfml} = \scomplement{\left(\imodel{\IddL}{\asfml}\right)} = \states\setminus\imodel{\IddL}{\asfml}$
            \item $\imodel{\IddL}{\asfml\land\bsfml} = \imodel{\IddL}{\asfml}\cap\imodel{\IddL}{\bsfml}$
            \item $\imodel{\IddL}{\holdssince{T}{\asfml(s)}} = \left\{\asstate\in\states \with \holdssince{T}{\asstate\in\imodel{\IddL}{\asfml(s)}} \right\}$
            \item $\imodel{\IddL}{\lforall{x}{\asfml}} = \{\asstate\in\states \with \modif{\asstate}{x}{y}\in\imodel{\IddL}{\asfml} \text{ for all } y\in\statespace \}$
            \item $\imodel{\IddL}{\lexists{x}{\asfml}} = \{\asstate\in\states \with \modif{\asstate}{x}{y}\in\imodel{\IddL}{\asfml} \text{ for some } y\in\statespace \}$
            \item $\imodel{\IddL}{\dbox{\asprg}{\asfml}} = \{\asstate\in\states \with \bsstate\in\imodel{\IddL}{\asfml} \text{ for all $\bsstate$ such that} (\asstate,\bsstate)\in\ireachability{\IddL}{\asprg}\}$, i.e. $\{\asstate\in\states \with \lforall{\bsstate\in\states}{((\asstate,\bsstate)\in\ireachability{\IddL}{\asprg} \limply \bsstate\in\imodel{\IddL}{\asfml})}\}$
            \item $\imodel{\IddL}{\ddiamond{\asprg}{\asfml}} = \{\asstate\in\states \with \bsstate\in\imodel{\IddL}{\asfml} \text{ for some $\bsstate$ such that} (\asstate,\bsstate)\in\ireachability{\IddL}{\asprg}\}$, i.e. $\{\asstate\in\states \with \lexists{\bsstate\in\states}{((\asstate,\bsstate)\in\ireachability{\IddL}{\asprg} \land \bsstate\in\imodel{\IddL}{\asfml})}\}$
        \end{enumerate}
        That formula $\asfml$ is true in state $\asstate$ under interpretation $\interpret$ can also be written as $\interpret,\asstate\models\asfml$. The formula is called valid, written as $\models\asfml$, iff $\asfml$ is true in all states under all interpretations.
    \end{definition}

    interpretation of predicate symbol, arity n: relation $I(p)\subseteq\R^n$
    interpretation of a quantifier symbol: functional $I(C):M\subseteq\states\to P(\states)$ maps subsets of states to subsets of states

    Atomic formulas (type 1 and 2) need to be combined with the quantification over s (6) in order to make sense. See Section \ref{sec:well-definedness}.

    With the semantics of terms if follows for the meaning of $\dbox{\asprg}{\phi}$, that $\phi$ must only hold up to time $\tau$ before leaving the \HP $\asprg$. It is possible, that $\phi$ was not verified before, while \emph{executing} the \HP.

    However when we apply the Rule of steps, we get the validity of $\phi$ for the entire trace.

    % TODO: is it better to only have xtau and not choice? What if both mentioned?
    in formulae (such as safety condition or evolution constraint), we have two possibilities: only value at current time instant ($x$) or for entire last $\tau$ time $\xtau$

    $\dbox{}{}$ and $\ddiamond{}{}$ only refer to last state and not intermediate states, as \dTL does.

    If no dependance on $s$ in terms, $\holdssince{T}{}$ can be dropped in formula.

    \begin{example}
        \begin{equation}
            \holdssince{T}{x+\xtau[s]\geq 0}\\
            \holdssince{T}{x+\xtau\geq 0} 
        \end{equation}
        can be dropped in second
    \end{example}

    % TODO: do we accept that or restrict formula after modality to not having $s$ free? then, since s\notin\asprg commutes also for diamond
    \begin{lemma}
        box and forall-s commute
        \begin{equation}
            \imodel{\IddL}{\holdssince{T}{\dbox{\asprg}{\asfml(s)}}} = \imodel{\IddL}{\dbox{\asprg}{(\holdssince{T}{\asfml(s)})}}
        \end{equation}
    \end{lemma}
    \begin{proof}
        \begin{multline}
            % FIXME: use \set instead of {}
            \imodel{\IddL}{\holdssince{T}{\dbox{\asprg}{\asfml(s)}}}\\
            = \set{\asstate\in\states \with \holdssince{T}{\lforall{\bsstate\in\states}{(\asstate,\bsstate)\in\ireachability{\IddL}{\asprg} \limply \bsstate\in\imodel{\IddL}{\asfml(s)}}}}\\
            = \set{\asstate\in\states \with \lforall{\bsstate\in\states}{\holdssince{T}{(\asstate,\bsstate)\in\ireachability{\IddL}{\asprg} \limply \bsstate\in\imodel{\IddL}{\asfml(s)}}}}\\
            = \set{\asstate\in\states \with \lforall{\bsstate\in\states}{(\asstate,\bsstate)\in\ireachability{\IddL}{\asprg} \limply \holdssince{T}{\bsstate\in\imodel{\IddL}{\asfml(s)}}}}\\
            = \set{\asstate\in\states \with \lforall{\bsstate\in\states}{(\asstate,\bsstate)\in\ireachability{\IddL}{\asprg} \limply \bsstate\in\imodel{\IddL}{\holdssince{T}{\asfml(s)}}}}\\
            = \imodel{\IddL}{\dbox{\asprg}{(\holdssince{T}{\asfml(s)})}}
        \end{multline}
        since $\lforall{x}{p\limply q(x)}\equiv p\limply\lforall{x}{q(x)}$
    \end{proof}
    However
    % TODO: is this a problem? or okay?
    \begin{equation}
        \imodel{\IddL}{\holdssince{T}{\ddiamond{\asprg}{\asfml(s)}}} \neq \imodel{\IddL}{\ddiamond{\asprg}{(\holdssince{T}{\asfml(s)})}}
    \end{equation}

    Since, with respect to \dL, the state space has been replaced, we need to redefine the semantics.
    
    \begin{definition}[Transition semantics of \HPs]\label{def:semantic-HP}
        The interpretation of a \HP is given by a binary \emph{reachability relation} $\ireachability{\IddL}{\asprg}\subseteq\states\times\states$ between states:
        \begin{enumerate}
            \item $\ireachability{\IddL}{a} = \interpret[a]$ for a program constant $a$
            \item $\ireachability{\IddL}{\hupdate{\humod{x}{\astrm}}} =
                \left\{(\asstate,\bsstate)\with \bsstate = \asstate \text{ except }
                \bsstate(x) = \left(s\mapsto\begin{cases}
                    \ivaluation{\IddL}{\theta(s)} & s=0\\
                    \asstate(s) & s\in[-T,0)
                \end{cases}\right)\right\}$
            \item $\ireachability{\IddL}{\Dupdate{\Dumod{\D{x}}{\astrm}}} =
                \left\{(\asstate,\bsstate)\with \bsstate = \asstate \text{ except }
                \bsstate(\D{x}) = \left(s\mapsto\begin{cases}
                    \ivaluation{\IddL}{\theta(s)} & s=0\\
                    \asstate(s) & s\in[-T,0)
                \end{cases}\right)\right\}$
            \item $\ireachability{\IddL}{\htest{\asfmlfolR}} = \left\{(\asstate,\asstate) \with \asstate\in\imodel{\IddL}{\asfmlfolR} \right\}$
            \item $\ireachability{\IddL}{\hchoice{\asprg}{\bsprg}} = \hchoice{\ireachability{\IddL}{\asprg}}{\ireachability{\IddL}{\bsprg}}$
            \item $\ireachability{\IddL}{\asprg;\bsprg} = \left\{ (\asstate,\bsstate) \with (\asstate,\csstate)\in\ireachability{\IddL}{\asprg}, (\csstate,\bsstate)\in\ireachability{\IddL}{\bsprg} \right\}$
            \item $\ireachability{\IddL}{\hrepeat{\asprg}} %= \hrepeat{(\ireachability{\IddL}{\asprg})}
                = \displaystyle\cupfold_{n\in\N}\ireachability{\IddL}{\asprg^n}$ with $\asprg^{n+1}\equiv (\asprg^n;\asprg)$ and $\asprg^0\equiv \htest{\ltrue}$
            \item $\ireachability{\IddL}{\hevolvein{\D{x}=\astrm(-\tau)}{\ivr}} = \{
                (\asstate,\bsstate) \with
                \lforall{\zeta\in[0,r]}{\trajectory(\zeta)\in\imodel{\IddL}{\hevolve{\D{x}=\astrm(-\tau)}\land\ivr}}$
                and $\asstate=\trajectory(0)$ on $\scomplement{\{\D{x}\}}$ and $\bsstate=\trajectory(r)\}$, i.e. there exists a $r\geq 0$ and a trajectory $\trajectory\from [0,r]\to\states$, which fulfills $\trajectory(\zeta)(\D{x})(0) \defeq \DD{\trajectory(t)(x)(0)}{t}(\zeta) \stackrel{!}{=} \ivaluation{\iconcat[state=\trajectory(\zeta)]{\IddL}}{\theta}$
        \end{enumerate}
    \end{definition}

    $\trajectory$ solves the DDE and satisfies $\ivr$ in each time instant/state

    The formula $\hevolve{\D{x}=\astrm(-\tau)}\land\ivr$ has dropped the $\holdssince{T}{}$, alloccurences of $x$ and $\D{x}$ of form with constant

    if $r=0$: 

    For the \emph{discrete assignment}, we only allow the values at the current time instant to be changed. A functional assignment would essentially allow to rewrite history, which is not permitted.

    This assignment is the actual reason why we need to consider piecewise continuous evolutions.

    

    %TODO: super dense time: multiple assignments, only consider last assignment

    Using the extended syntax, we can write down both a delay differential equation and an ordinary differential equation in the form $\D{x}=\theta$, where $\theta=f(x,\xtau)$ with a polynomial $f$.

    Along a DDE/ODE, values of differential symbols coincide with time derivative of value of corresponding variable
    Remember that a $\xtau$ mentioned in $\theta$ here means $\varphi(t)(x)(-\tau)$.
    And so needs $\ivr$ always just hold at the current time instant (and not over the entire interval $[-\tau,0]$). The same case for $\ptest\psi$.

    \begin{lemma}[Differential Lemma]
        lecture notes L10.20
        needed for DI proof
        no changes, except for rewriting $\varphi(t)(x)\rightarrow\varphi(t)(x)(0)$
    \end{lemma}


\section{Static Semantics}
    \label{sec:static-semantics}

    \subsection{History Horizon}
        \label{sec:history-horizon}

        \begin{definition}[History Horizon]
            The \emph{history horizon} is a function
            \begin{equation*}
                \HHfml\from \ddLformulas \to \R_{\leq 0}
            \end{equation*}
            which assigns to each \ddL formula the earliest point in time it references to. It limits the time interval of the state space $T\in$.
            The history horizon depends on all occurences of $\xtau[s]$ and $\xtau[c]$ in the formula.

            It is defined inductively for formulas by:
            \begin{enumerate}
                \item $\HHfml(\holdssince{T}{\astrm\geq\bstrm}) = \max\set{\HHtrm(\astrm),\HHtrm(\bstrm)}$
                \item $\HHfml(\holdssince{T}{p(\range{\istrm{1}}{\istrm{k}})}) = \max\set{\range{\HHtrm(\istrm{1})}{\HHtrm(\istrm{k})}}$
                \item $\HHfml(\contextapp{C}{\asfml}) = $
                \item $\HHfml(\lnot\asfml) = \HHfml(\asfml)$
                \item $\HHfml(\asfml\land\bsfml) = \max\set{\HHfml(\asfml),\HHfml(\bsfml)}$
                \item $\HHfml(\lforall{x}{\asfml}) = \HHfml(\asfml)$
                \item $\HHfml(\lexists{x}{\asfml}) = \HHfml(\asfml)$
                \item $\HHfml(\dbox{\asprg}{\asfml}) = \max\set{\HHprg(\asprg),\HHfml(\asfml)}$
                \item $\HHfml(\ddiamond{\asprg}{\asfml}) = \max\set{\HHprg(\asprg),\HHfml(\asfml)}$
            \end{enumerate}
            depending on terms
            \begin{enumerate}
                \item $\HHtrm(\xtau[s]) = 0$
                \item $\HHtrm(\Dxtau[s]) = 0$
                \item $\HHtrm(\xtau[c]) = \abs{c}$
                \item $\HHtrm(\Dxtau[c]) = \abs{c}$
                \item $\HHtrm(c) = 0$
                \item $\HHtrm(f(\range{\istrm{1}}{\istrm{k}})) = \max\set{\range{\HHtrm(\istrm{1})}{\HHtrm(\istrm{k})}}$
                \item $\HHtrm(\astrm + \bstrm) = \max\set{\HHtrm(\astrm),\HHtrm(\bstrm)}$
                \item $\HHtrm(\astrm \cdot \bstrm) = \max\set{\HHtrm(\astrm),\HHtrm(\bstrm)}$
            \end{enumerate}
            and \HPs
            \begin{enumerate}
                \item $\HHprg(a) = 0$
                \item $\HHprg(\hupdate{\humod{x}{\astrm}}) = 0$
                \item $\HHprg(\Dupdate{\Dumod{\D{x}}{\astrm}}) = 0$
                \item $\HHprg(\htest{\asfmlfolR}) = 0$
                \item $\HHprg(\hchoice{\asprg}{\bsprg}) = \max\set{\HHprg(\asprg),\HHprg(\bsprg)}$
                % TODO: replace ; in HPs
                \item $\HHprg(\asprg;\bsprg) = \max\set{\HHprg(\asprg),\HHprg(\bsprg)}$
                \item $\HHprg(\hrepeat{\asprg}) = \HHprg(\asprg)$
                \item $\HHprg(\hevolvein{\D{x}=\astrm(-\tau)}{\ivr}) = \HHtrm(\astrm(-\tau))$
            \end{enumerate}
            For formulae as
            
            T in forall: comp, pred
            minimum of T in forall parts of subformulas: quantifier, not and
            forall, exists?
            modalities: max $\tau$ in DDE and of formula
        \end{definition}
        %We need to use $\min$, since $\HH$ is a non-positive number. It is the biggest in absolute value.
    
    \subsection{Variable Binding}
        \label{sec:variable-binding}

        \begin{definition}[Free variable]
            for terms: $\freevars{\astrm}\subseteq\allvars\cup\diffvars\cup\set{s}$, variables that occur in term
            \begin{align*}
                \freevars{\xtau[s]} &= \set{x,s}\\
                \freevars{\Dxtau[s]} &= \set{\D{x},s}\\
                \freevars{\xtau[b]} &= \set{x}\\
                \freevars{\Dxtau[b]} &= \set{\D{x}}\\
                \freevars{c} &= \emptyset\\
                \freevars{f(\range{\istrm{1}}{\istrm{k}})} &= \freevars{\istrm{1}} \cup\cdots\cup \freevars{\istrm{k}}\\
                \freevars{\astrm + \bstrm} = \freevars{\astrm \cdot \bstrm} &= \freevars{\astrm}\cup\freevars{\bstrm}\\
                \freevars{\D{(\astrm)}} &= \freevars{\astrm}\cup\D{\freevars{\astrm}}
            \end{align*}
                
        \end{definition}    

    \subsection{Well-defined Formulae}
        \label{sec:well-definedness}
    
        $s$ must not be free
        and

        \begin{definition}[Well-defined formula]
            obeys syntactic definition
            premisse defines element od statespace for all occuring variables and diffs
        \end{definition}

        \begin{example}
            \begin{equation*}
                % FIXME: notation/syntax: ausgeklammertes forall in formulas
                \dbox{\hupdate{\humod{x}{\xtau[-3]^2}};\hevolvein{\D{x}=\xtau+2x}{(x\geq 0)}}{\holdssince{T}{0\leq \xtau[s] \land \xtau[s]\leq\xtau[-5]}}
            \end{equation*}
            Hence the history horizon needs to be set to
            \begin{equation*}
                T=\max\set{\max\set{3,\tau},\max\set{0,5}}.
            \end{equation*}
        \end{example}

        % TODO: feasible history horizon for a HP
        \begin{lemma}
            choosing the statespace according to history horizon of HP determines
        \end{lemma}

        \begin{example}
            
        \end{example}
