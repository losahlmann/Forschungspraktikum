\chapter{Delay Differential Dynamic Logic}
\label{ch:delay-differential-dynamic-logic}

We extent classical differential dynamic logic (\dL) (see e.g.~\cite{Platzer12LogicsDynSys}) with syntax, semantics, axiomatization and proof rules to support reasoning about hybrid dynamical systems with delay.

To that purpose, we allow delay differential equations in hybrid programs, which are then called \emph{delay hybrid program} (\dHP).

The definition of \emph{delay differential dynamic logic} (\ddL) provides all operators of first-order logic, as well as modal operators, in order to specify and verify reachability properties about the state of such \dHPs.

In the language of \ddL, we can not only model hybrid programs with DDEs in the continuous part, but also with temporal differences in the discrete fragment.
For example a controller which approximates a derivative by a difference quotient.

The logic \ddL is a superset of \dL, i.e.\ in the absence of any delay, it reduces to classical \emph{differential dynamic logic}.


% Similiar to first-order logic and essentially as an extension of dL we define delay differential logic
% in general an arbitrary unknown initial function, only conditions on it

% time-invariant

% safety and liveness properties specify

% TODO: Abgrenzung zu Trace Semantics
    % The temporal character of delay differential equations (they depend on their own temporal evolution with limited horizon) suggests the introduction of trace semantics.
    %
    % However, we go the way of introducing transition semantics with an augmented state space.

\section{Syntax}
    \label{sec:syntax}

    Terms and formulas in \ddL, as well as \dHPs are defined as \emph{words} of finite length, produced by their corresponding grammars in Backus-Naur-form (BNF).
    % The syntax of is defined inductively by 

    We define by $\allvars$ be the set of \emph{all variables} and by $\diffvars\defeq\Set{\D{x} \with x\in\allvars}$ the corresponding set of \emph{differential symbols}.
    % TODO: call delay or delayed?
    Let $\constants\subset\nonposQ$ be the set of \emph{constant parameters}.
    All three sets are supposed to be finite.
    We denote $\delayvars\defeq\Set{\x[c] \with x\in\allvars,\ c\in\constants}$ as the set of \emph{delay variables} and $\delaydiffvars\defeq\Set{\Dx[c] \with \D{x}\in\diffvars,\ c\in\constants}$ as the set of \emph{delay differentials}.
    % TODO: finite sets, or sets infinite, but only finitely many symbols in one term/formula, Trm()
    % FIXME: parentheses

    We will usually write variables as $x,y,z\in\allvars$ and their differential symbols as $\D{x},\D{y},\D{z}\in\diffvars$.
    % FIXME: just use \Q as set of constants, they have their semantics
    \emph{Function symbols} $f,g,h$ and \emph{constant symbols} $a,b\in\Q$
    % FIXME: do I use predicates?
    % \emph{predicate symbols} $p,q,r$
    are as in first-order logic (cf.\ Section~\ref{sec:first-order-logic}).

    Moreover, we write $\astrm,\bstrm$ for \ddL terms, $\asfml,\bsfml$ for \ddL formulas and $\asprg,\bsprg$ for \dHPs. For formulas of first-order logic of real arithmetic (\FOLR), we use the symbols $\asfmlfolR$ and $\bsfmlfolR$.

    \begin{definition}[s-Terms]\label{def:syntax-terms}
        The syntax of \emph{terms} of \emph{delay differential dynamic logic} is defined by the following grammar:
        \begin{align*}
            \astrm(s),\bstrm(s) \Coloneqq{}&
                \x[s] \mid
                \Dx[s] \mid
                \x[c] \mid
                \Dx[c] \mid
                a \mid\\
                & f(\range{\istrm{1}(s)}{\istrm{k}(s)}) \mid
                \astrm(s) + \bstrm(s) \mid
                \astrm(s) \cdot \bstrm(s) \mid
                \D{(\astrm(s))}
        \end{align*}
        % FIXME: is term' allowed? diff inv is only a FOLR formula? even for dL valid?
        % TODO: line breaks and explination text in syntax
        % \begin{align}
        %     \astrm\Coloneqq{}&\\
        %     &\mid \astrm+\bstrm\hfill\text{test}
        % \end{align}
        where $x\in\allvars,\D{x}\in\diffvars$ and $f$ is a function symbol of arity $k$.
        The symbol $a\in\constants$ stands for a constant value in $\Q$. The constant parameters $c\in\nonposQ$ are not allowed to be positive.
    \end{definition}

    The s-terms listed in the first line are called \emph{atomic}, as opposed to the \emph{composite} s-terms in the second line.
    % FIXME: what is f like?
    %extending \dL with symbols for \emph{delayed variables} and \emph{differentials}
    S-terms generally depend on the time parameter $s\in\nonposR$. This is why we write them as $\astrm(s)$.
    If a s-term $\astrm(s)$ does neither contain $\x[s]$ nor $\Dx[s]$, we say $s\notin\astrm(s)$ and abbreviate its notation to $\astrm$.
    Writing $\astrm(b)$ means that all occurences of $s$ in $\astrm(s)$ have been replaced with $b\in\nonposQ$.
    Moreover, we agree on abbreviating $\x[0]$ to $x$ and $\Dx[0]$ to $\D{x}$.
    % The variable symbol $x$ and the differential symbol $\D{x}$ are the only ones which allow explicitely mentioning this parameter. They are spelled slightly differently using square brackets as $\x[s]$ and $\Dx[s]$, respectively.
    Note that $s\notin\allvars\cup\diffvars\cup\constants$. It is a special variable symbol.

    The \emph{differential} $\D{(\astrm(s))}$ of a term $\astrm(s)$ is its syntactic (total) derivation, obtained by standard differentiation rules.
    Lemma~\ref{lm:derivations} shows the validity of these rules and that the result is again a s-term.

    Subtraction can be defined using addition and multiplication, division would also be possible, if we can exclude any division by zero. The grammar allows in particular the construction of polynomial forms.

    \begin{example}
        Let us consider the s-term
        \begin{equation*}
            \astrm(s) = \x[s] + \x[-\tau].
        \end{equation*}
        Setting $s=-1$ gives the term
        \begin{equation*}
            \astrm(-1) = \x[-1] + \x[-\tau].
        \end{equation*}
    \end{example}

    Delay differential dynamic logic uses hybrid programs with delay differential equations as system model. 
    The grammar defining these \emph{delayed hybrid programs} is the same as for classical \HPs (cf.~\cite{Platzer15Uniform}).

    \begin{definition}[Delay Hybrid Programs]\label{def:syntax-HP}
        The syntax of \emph{delay hybrid programs} (\dHPs) is defined by
        % TODO: first-order logic of real arithmetic formulas include \x?
        \begin{equation*}
            \asprg,\bsprg \Coloneqq
                \hupdate{\humod{x}{\astrm}} \mid
                \Dupdate{\Dumod{\D{x}}{\astrm}} \mid
                % TODO: only FOLR
                \htest{\asfml(s)} \mid
                \hchoice{\asprg}{\bsprg} \mid
                % TODO: replace ; in HPs
                \asprg;\bsprg \mid
                \hrepeat{\asprg} \mid
                \hevolvein{\D{x}=\astrm}{\ivr}
        \end{equation*}
        where $\asprg,\bsprg$ denote \dHPs, $x$ a variable and $\astrm$ a term (possibly containing $x$ or $\x[b]$, but no $\x[s]$).
        The formula $\asfmlfolR$ is of \FOLR, containing only normal variable symbols from $\allvars$.
    \end{definition}
    
    Note that the syntax only allows autonomous DDEs, though with multiple constant delays.

    Atomic \dHPs are given by instantaneous discrete \emph{assignments} $\hupdate{\humod{x}{\astrm(0)}}$ and \emph{differential assignments} $\Dupdate{\Dumod{\D{x}}{\astrm(0)}}$, which change the value of the given variable only at the current time instant, not the past, \emph{tests} $\htest{\asfml(s)}$, which pass only if the current state satisfies the formula $\asfml$
    % first-order formula $\asfmlfolR$ of real arithmetic
    and abords the program execution if not, as well as evolutions along \emph{delay differential equation} systems $\hevolvein{\D{x}=\astrm(0)}{\ivr}$ of an arbitrary amount of time, but restricted by the evolution domain constraint $\ivr$.

    Compound \dHPs combine atomic programs, and comprise \emph{nondeterministic choices} $\hchoice{\asprg}{\bsprg}$, running either $\asprg$ or $\bsprg$, \emph{sequential compositions} $\asprg;\bsprg$, executing $\bsprg$ after $\asprg$ and \emph{nondeterministic repetitions} $\hrepeat{\asprg}$, repeating $\asprg$ any number of times, zero times included.

% Using this, in comparison to \dL extended syntax, we can write down both delay differential equations and ordinary differential equations in the form $\D{x}=\theta$, where $\theta=f(x,\x[-\tau])$ with a polynomial $f$.
    Observe that ODEs are still expressible by this syntax and that hybrid programs are hence only delayed hybrid programs with zero delay.

    % FIXME: where put general dL sources? only once at beginning
    The difference between classical \HPs (as defined in \dL, cf.~\cite{Platzer10HybridSystems,Platzer12LogicsDynSys,Platzer15Uniform}) and \emph{delay hybrid programs} is not syntactical, but only given by their semantics.
    
    \begin{definition}[s-Formulas]\label{def:syntax-formula}
        The syntax for \emph{formulae} of \emph{delay differential dynamic logic} is defined by the grammar
        \begin{align*}
            \asfml(s),\bsfml(s) \Coloneqq{}& % fixes missing space
                % TODO: better abbreviated notation for \holdssince, make forall only appear in semantics rhs
                \astrm(s) = \bstrm(s) \mid
                \astrm(s)\geq\bstrm(s) \mid
                p(\range{\istrm{1}(s)}{\istrm{k}(s)}) \mid
                \hs{\asfml(s)} \mid\\
                &\lnot\asfml(s) \mid
                \asfml(s)\land\bsfml(s) \mid
                \lforall{x}{\asfml(s)} \mid
                \lexists{x}{\asfml(s)} \mid
                \dbox{\asprg}{\asfml(s)} \mid
                \ddiamond{\asprg}{\asfml(s)}
        \end{align*}
        with $\astrm(s),\bstrm(s),\range{\istrm{1}(s)}{\istrm{k}(s)}$ as s-terms, $p$ as predicate symbol, $x$ as variable, and $\asprg$ as \dHP.
    \end{definition}

    These formulae combine connectives of propositional logic with first-order quantifiers (which both have standard meaning) and two modalities, describing \emph{necessary} and \emph{possible} properties.

    The other comparison operators $<,\leq,>$ and logic connectives $\lor,\limply,\lbisubjunct$ can be defined using $=,\land,\lnot$ and are hence not explicitely mentioned in the grammar.
    Analogoulsy is $\lexists{x}{\asfml}$ expressible as $\lnot\lforall{x}{\lnot\asfml}$ and the modal formula $\dbox{\asprg}{\asfml}$ ($\asfml$ holds in the state after all runs of $\asprg$) by its dual $\ddiamond{\asprg}{\asfml}\equiv\lnot\dbox{\asprg}{\lnot\asfml}$ (there is at least one state reachable by $\asprg$ such that $\asfml$ holds).
    The quantifiers $\forall$ and $\exists$ quantify over the state space $\statespace$.
    % FIXME: was state space mentioned before?

    Like the s-terms defined above, the s-formulae depend on a time parameter $s\in\closeddelayinterval$. The symbol $T$ is a symbolic constant related to the length of the domain of the state space, which is induced by the occurence of delay symbols. Its value is defined by the static semantics and set by proof rules.
    % TODO: proof rule/axiom to set T?
    The only way to bind the variable $s$ in a formula $\asfml(s)$ is by using $\hs{\asfml(s)}$, which quantifies $s$ over the domain of the state space, except for the current time point $0$.

    We note $\asfml$ to indicate that $s$ is not a free variable of $\asfml(s)$ and $\asfml(b)$ with $b\in\nonposQ$ to express that each term $\astrm(s)$ in the formula was replaced by its corresponding $\astrm(b)$, even if it was bound by a $\hs{}$.
    % TODO: or only which is not under the scope of a \hs? at the moment I overwrite each \hs
    If we write $\asfml(x)$, we mean entire function $x$, not only the value $\x[0]$ (cf.\ usage for $\forall$).
    
    % TODO: on variables \allvars (signature)
    Formulas of first-order logic of real arithmetic constitute a subset of \ddL, i.e.\ every \FOLR formula is also a formula of delay differential dynamic logic.

    \begin{convention}
        The frequently appearing fact that $\asfml(s)$ is not only supposed to hold for $s\in\delayinterval$ but also in $s=0$
        \begin{equation*}
            \hs{\asfml(s)}\land\asfml(0)
        \end{equation*}
        can also be written as
        \begin{equation*}
            \hsc{\asfml(s)}
        \end{equation*}
        For convenience, we allow the latter, abbreviated notation, which is implicitely replaced by the former, syntactically correct version.
    \end{convention}

    In order to simplify notation by eliminating parentheses, we agree on the following
    \begin{convention}
        The operators in \ddL formulae obey the following binding priorities (from highest to lowest):
        \begin{itemize}
            \item the quantifiers $\forall,\exists$ and the modal operators $\dbox{\cdot}{},\ddiamond{\cdot}{}$ bind strongest
            \item negation $\lnot$ binds stronger than
            \item conjunction $\land$ binds stronger than 
            \item disjunction $\lor$ binds stronger than
            \item implication $\limply$ binds stronger than
            \item equivalence $\lbisubjunct$, which binds weakest.
        \end{itemize}
    \end{convention}

        % TODO: Move to static semantics
    Moreover, when a s-formula does not depend on the quantified parameter $s$, we can drop the quantifier $\hs{}$ in which this formula appears.

    \begin{example}
        Consider the two well-formed \ddL formulae:
        \begin{align*}
            &\hs{(x+\x[s]\geq 0)}\\
            &\hs{(x+\x[-\tau]\geq 0)} 
        \end{align*}
        The quantification over $s$ in the second formula can be dropped, what leads to the equivalent formula
        \begin{equation*}
            x+\x[-\tau]\geq 0.
        \end{equation*}
    \end{example}


\section{Dynamic Semantics}
    \label{sec:dynamic-semantics}

    % TODO: this is called valuation

    In this section, we give meaning to the syntax introduced above, by defining its semantics in a compositional way.

    Following the remark to the solution of a DDE (cf.\ Section~\ref{sec:definition-of-solution}), we define the \emph{state space} in \ddL as $\statespace$, the set of piecewise continuously differentiable functions on $\closeddelayinterval$, as defined in Definition~\ref{def:piecewise-continuous}.
    This means that a variable remembers a limited part of its evolution history, what demands hence an implicit notion of a underlying time.

    We denote by $\states$ the \emph{set of states}. A \emph{state} $\asstate\in\states$ is a mapping
    \begin{equation}
        \asstate \from \allvars\cup\diffvars \to \statespace
    \end{equation}
    which assigns a \emph{history} (function) to each variable and differential symbol.

    By $\modif{\asstate}{x}{y}$ we denote the state which is equal to state $\asstate$, except for the value of the variable $x$, which is set to $y\in\statespace$.

    % FIXME: modification of x in state and general specification of pw function associated to x
    %at the time $t=0$. The value of $x$ for the time before does not change.

    % FIXME: let interpretation $\interpret$ be fixed
    

    \begin{definition}[Semantics of s-terms]\label{def:sematic-terms}
        The \emph{semantics} of a s-term $\astrm(s)$ in the state $\asstate\in\states$ with respect to the time instant $\past\in\closeddelayinterval$
        is a value in $\R$ and defined inductively as follows:
        \begin{enumerate}
            \item $\ivaluation{\IddL}{\x[s]} = \asstate(x)(\past)$ for a variable $x\in\allvars$
            % FIXME: need Cpw for derivatives or only \R?
            \item $\ivaluation{\IddL}{\Dx[s]} = \asstate(\D{x})(\past) \defeq \lim_{t\downto \past} \frac{\asstate(x)(t)-\asstate(x)(\past)}{t-\past}$ (except in $\past=0$)
            % for a differential symbol $\D{x}\in\diffvars$
            \item $\ivaluation{\IddL}{\x[c]} = \asstate(x)(c)$ for a variable $x\in\allvars$ 
            % \item $\ivaluation{\IddL}{\Dx[b]} = \asstate(\D{x})(b)$ for a differential symbol $\D{x}\in\diffvars$ and a constant $b\in\constants$ with $\interpret[b]\in\nonposQ$
            \item $\ivaluation{\IddL}{\Dx[c]} = \asstate(\D{x})(c) \defeq \lim_{t\downto c} \frac{\asstate(x)(t)-\asstate(x)(c)}{t-c}$ (except in $c=0$)
            \item $\ivaluation{\IddL}{a} = \interpret[a]$ for a constant $a\in\constants$
            \item $\ivaluation{\IddL}{f(\range{\istrm{1}(s)}{\istrm{k}(s)})} = \interpret[f](\range{\ivaluation{\IddL}{\istrm{1}(s)}}{\ivaluation{\IddL}{\istrm{k}(s)}})$ for a function symbol $f$
            \item $\ivaluation{\IddL}{\astrm(s)+\bstrm(s)} = \ivaluation{\IddL}{\astrm(s)} + \ivaluation{\IddL}{\bstrm(s)}$
            \item $\ivaluation{\IddL}{\astrm(s)\cdot\bstrm(s)} = \ivaluation{\IddL}{\astrm(s)} \cdot \ivaluation{\IddL}{\bstrm(s)}$
            % FIXME: derivation of terms with x'?
            \item $\ivaluation{\IddL}{\D{(\astrm(s))}} = \displaystyle\sum_{\x[c]\in\delayvars} \asstate(\D{x})(\interpret[c])\frac{\partial\ivaluation{\IddL}{\astrm(s)}}{\partial \x[b]} + \asstate(\D{x})(\past)\frac{\partial\ivaluation{\IddL}{\astrm(s)}}{\partial \x[s]}$
        \end{enumerate} 
        where $c\in\nonposQ$ is a non-positive rational number.
    \end{definition}
        % FIXME: interpretation of $f$ is a smooth function?

    The meaning of the variable and differential symbols is determined by the state. Additionally, the value of a differential symbol has to coincide with the right derivative of the corresponding variable, except for $\past=0$.

    The meaning of the differential of an arbitrary term is the total derivative of its value with respect to the underlying continuous time.
    As a composition of smooth functions is $\ivaluation{\IddL}{\astrm(s)}$ smooth itself and hence these derivatives exist.
    The sum is finite, since each term only mentions finitely many variables.

    % The meaning of a differential symbol: defined by state, 
    % The time derivative of a variable may not be defined in isolated state, because it might have a discontinuity here and we cannot use its history (provided by the state) to define derivative.
    % However, we can define a state local semantics for a differential $\D{(\astrm)}$.

    % Like for ODE case, only use last value given in state. Since in $t=0$ could be incontinuity 

    

    % Along a solution of a DDE $\varphi:[0,r]\rightarrow\states$ (continous differentiable), the differential symbols are interpreted as time derivatives, $r>0$ at any $\zeta\in[0,r]$, meaning of symbol is rate of change of value of $x$ over time
    % \begin{equation}
    %     % TODO: replace \DD with Andres command
    %     \imodel{\IddL}{\D{x}}\varphi(\zeta)
    %         = \varphi(\zeta)(\D{x})(0)
    %         \defeq \DD{\varphi(t)(x)(0)}{t}(\zeta)
    %         = \DD{\imodel{\IddL}{x}\varphi(t)}{t}(\zeta)
    % \end{equation}
   
 
    

    In the precondition, no values are associated to the differential symbols. In general, the initial function is only piecewise continuous.
    Since for later time instances, the values of the differential symbols derive from the DDE, they become (locally) smooth function.

    \begin{definition}[Semantics of s-formulae]\label{def:semantic-formulae}
        The semantics of a \ddL formula $\asfml$ is the subset of all states $\imodel{\IddL}{\asfml}\subseteq\states$ in which $\asfml$ is true. This set is given inductively by
        % TODO: mention interpretation I
        % FIXME: what is difference between \imodel and \ivaluation?
        % terms: ivaluation, formula: imodel, programms: ireachability
        % FIXME: display assign for formula semantics
        \begin{enumerate}
            % TODO: replace : in set by \with
            % FIXME: use notation forall ... : ...
            % FIXME: *version for lforall without parentheses
            % FIXME: forall quantifies over state space or over possible values (reals) for system parameters?
            \item $\imodel{\IddL}{\astrm(s)=\bstrm(s)} = \Set*{\asstate\in\states \with \ivaluation{\IddL}{\astrm(s)} = \ivaluation{\IddL}{\bstrm(s)}}$
            \item $\imodel{\IddL}{\astrm(s)\geq\bstrm(s)} = \Set*{\asstate\in\states \with \ivaluation{\IddL}{\astrm(s)}\geq\ivaluation{\IddL}{\bstrm(s)}}$
            \item $\imodel{\IddL}{p(\range{\istrm{1}(s)}{\istrm{k}(s)})} = \Set*{\asstate\in\states \with \left(\range{\ivaluation{\IddL}{\istrm{1}(s)}}{\ivaluation{\IddL}{\istrm{k}(s)}}\right)\in\interpret[p]}$
            \item $\imodel{\IddL}{\lnot\asfml(s)} = \scomplement{\left(\imodel{\IddL}{\asfml(s)}\right)} = \states\setminus\imodel{\IddL}{\asfml(s)}$
            \item $\imodel{\IddL}{\asfml(s)\land\bsfml(s)} = \imodel{\IddL}{\asfml(s)}\cap\imodel{\IddL}{\bsfml(s)}$
            \item $\imodel{\IddL}{\hs{\asfml(s)}} = \Set*{\asstate\in\states \with \mforall{\tilde{r}\in\delayinterval}\holds\asstate\in\imodel{\iconcat[assign=\tilde{r}]{\IddL}}{\asfml(s)}}$
            \item $\imodel{\IddL}{\lforall{x}{\asfml(s)}} = \Set*{\asstate\in\states \with \modif{\asstate}{x}{y}\in\imodel{\IddL}{\asfml(s)} \text{ for all } y\in\statespace}$
            \item $\imodel{\IddL}{\lexists{x}{\asfml(s)}} = \Set*{\asstate\in\states \with \modif{\asstate}{x}{y}\in\imodel{\IddL}{\asfml(s)} \text{ for some } y\in\statespace}$
            \item $\imodel{\IddL}{\dbox{\asprg}{\asfml(s)}} = \Set*{\asstate\in\states \with \bsstate\in\imodel{\IddL}{\asfml(s)} \text{ for all $\bsstate$ such that} (\asstate,\bsstate)\in\ireachability{\IddL}{\asprg}}$,\\ i.e. $=\Set*{\asstate\in\states \with \mforall{\bsstate\in\states}\holds(\asstate,\bsstate)\in\ireachability{\IddL}{\asprg} \mimply \bsstate\in\imodel{\IddL}{\asfml(s)}}$
            \item $\imodel{\IddL}{\ddiamond{\asprg}{\asfml(s)}} = \Set*{\asstate\in\states \with \bsstate\in\imodel{\IddL}{\asfml(s)} \text{ for some $\bsstate$ such that} (\asstate,\bsstate)\in\ireachability{\IddL}{\asprg}}$,\\ i.e. $=\Set*{\asstate\in\states \with \mexists{\bsstate\in\states}\holds(\asstate,\bsstate)\in\ireachability{\IddL}{\asprg} \land \bsstate\in\imodel{\IddL}{\asfml(s)}}$
        \end{enumerate}
        The fact that formula $\asfml(s)$ is true in state $\asstate$ under the interpretation $\interpret$ at past time instant $\past\in\closeddelayinterval$, i.e. $\asstate\in\imodel{\IddL}{\asfml(s)}$ can also be written as $\interpret,\asstate,\past\models\asfml(s)$.
        A formula $\asfml(s)$ is called valid, written as $\models\asfml(s)$, if and only if $\asfml(s)$ is true in all states, for all $\past\in\closeddelayinterval$ and under all interpretations.
    \end{definition}

    As in classic first-order logic, the interpretation of a predicate symbol of arity n is a relation $\interpret[p]\subseteq\R^n$.

    % Atomic formulas (type 1 and 2) need to be combined with the quantification over s (6) in order to make sense. See Section \ref{sec:well-definedness}.

    % FIXME: text after HP semantics, add waht noted on white board
    % With the semantics of terms if follows for the meaning of $\dbox{\asprg}{\phi}$, that $\phi$ must only hold up to time $\tau$ before leaving the \HP $\asprg$. It is possible, that $\phi$ was not verified before, while \emph{executing} the \HP.

    % However when we apply the Rule of steps, we get the validity of $\phi$ for the entire trace.

    % TODO: is it better to only have xtau and not choice? What if both mentioned?
    % in formulae (such as safety condition or evolution constraint), we have two possibilities: only value at current time instant ($x$) or for entire last $\tau$ time $\x[-\tau]$

    % $\dbox{}{}$ and $\ddiamond{}{}$ only refer to last state and not intermediate states, as \dTL does.

    \begin{lemma}[Barcan formula]
        The box modality and the quantification over $s$ commute
        \begin{equation*}
            \imodel{\IddL}{\hs{\dbox{\asprg}{\asfml(s)}}} = \imodel{\IddL}{\dbox{\asprg}{(\hs{\asfml(s)})}}
        \end{equation*}
    \end{lemma}
    \begin{proof}
        Since $\mforall{x}\holds(p\mimply q(x))\equiv p\mimply\mforall{x}\holds q(x)$, it holds
        \begin{multline*}
            \imodel{\IddL}{\hs{\dbox{\asprg}{\asfml(s)}}} =\\
            \begin{aligned}
                &= \Set*{\asstate\in\states \with \holdssince[\tilde{r}]{-T}\mforall{\bsstate\in\states}\holds \left((\asstate,\bsstate)\in\ireachability{\IddL}{\asprg} \mimply \bsstate\in\imodel{\iconcat[assign=\tilde{r}]{\IddL}}{\asfml(s)}\right)}\\
                &= \Set*{\asstate\in\states \with \mforall{\bsstate\in\states}\holds\holdssince[\tilde{r}]{-T}\left((\asstate,\bsstate)\in\ireachability{\IddL}{\asprg} \mimply \bsstate\in\imodel{\iconcat[assign=\tilde{r}]{\IddL}}{\asfml(s)}\right)}\\
                &= \Set*{\asstate\in\states \with \mforall{\bsstate\in\states}\holds\left((\asstate,\bsstate)\in\ireachability{\IddL}{\asprg} \mimply \holdssince[\tilde{r}]{-T}\bsstate\in\imodel{\iconcat[assign=\tilde{r}]{\IddL}}{\asfml(s)}\right)}\\
                &= \Set*{\asstate\in\states \with \mforall{\bsstate\in\states}\holds\left((\asstate,\bsstate)\in\ireachability{\IddL}{\asprg} \mimply \bsstate\in\imodel{\IddL}{\hs\asfml(s)}\right)}\\
                &= \imodel{\IddL}{\dbox{\asprg}{(\hs{\asfml(s)})}}
            \end{aligned}
        \end{multline*}
    \end{proof}
    
    However, the diamond modality does not commute with the s-quantification.
    % TODO: counterexample for not commuting diamond and forall-s
    % TODO: do we accept that or restrict formula after modality to not having $s$ free? then, since s\notin\asprg commutes also for diamond
    \begin{equation*}
        \imodel{\IddL}{\hs{\ddiamond{\asprg}{\asfml(s)}}} \neq \imodel{\IddL}{\ddiamond{\asprg}{\hs{\asfml(s)}}}
    \end{equation*}

    % Since, with respect to \dL, the state space has been replaced, we need to redefine the semantics.
    
    \begin{definition}[Transition semantics of \dHPs]\label{def:semantic-dHP}
        The interpretation of a \dHP is given by a binary \emph{reachability relation} $\ireachability{\IddL}{\asprg}\subseteq\states\times\states$ between states:
        \begin{enumerate}
            % \item $\ireachability{\IddL}{a} = \interpret[a]$ for a program constant $a$
            % FIXME: astrm(s) or without s
            \item\label{itm:sem-dHP-assgn} $\ireachability{\IddL}{\hupdate{\humod{x}{\astrm}}} =
                \set{(\asstate,\bsstate)\with \bsstate=\asstate \text{ except }
                \bsstate(x) = \left(\past\mapsto\begin{cases}
                    \ivaluation{\IddL}{\astrm(s)} & \past=0\\
                    \asstate(x)(\past) & \past\in\delayinterval
                \end{cases}\right)}$
            \item $\ireachability{\IddL}{\Dupdate{\Dumod{\D{x}}{\astrm}}} =
                \set{(\asstate,\bsstate)\with \bsstate = \asstate \text{ except }
                \bsstate(\D{x}) = \left(\past\mapsto\begin{cases}
                    \ivaluation{\IddL}{\astrm(s)} & \past=0\\
                    \asstate(\D{x})(\past) & \past\in\delayinterval
                \end{cases}\right)}$
            % FIXME: no \assign for FOLR formula \imodel
            \item $\ireachability{\IddL}{\htest{\asfml(s)}} = \set{(\asstate,\asstate) \with \asstate\in\imodel{\IddL}{\asfml(s)}}$
            \item $\ireachability{\IddL}{\hchoice{\asprg}{\bsprg}} = \hchoice{\ireachability{\IddL}{\asprg}}{\ireachability{\IddL}{\bsprg}}$
            \item $\ireachability{\IddL}{\asprg;\bsprg} = \set{(\asstate,\bsstate) \with (\asstate,\csstate)\in\ireachability{\IddL}{\asprg}, (\csstate,\bsstate)\in\ireachability{\IddL}{\bsprg}}$
            \item $\ireachability{\IddL}{\hrepeat{\asprg}} 
                = \displaystyle\cupfold_{n\in\N_0}\ireachability{\IddL}{\asprg^n}$ with $\asprg^{n+1}\equiv (\asprg^n;\asprg)$ and $\asprg^0\equiv (\htest{\ltrue})$
            % TODO: semantics DDE
            \item\label{itm:sem-HP-DDE} $\ireachability{\IddL}{\hevolvein{\D{x}=\astrm}{\ivr}} = \{(\asstate,\bsstate) \;\vert\; \mforall{\zeta\in[0,r]}\holds\trajectory(\zeta)\in\imodel{\IddL}{\hevolve{\D{x}=\astrm}\land\ivr}$ and $\asstate=\trajectory(0)$ on $\scomplement{\Set{\D{x}}}$ and $\bsstate=\trajectory(r)$ for a $\trajectory\from [0,r]\to\states\}$, i.e. there exists a $r\geq 0$ and a trajectory $\trajectory\from [0,r]\to\states$, which fulfills $\trajectory(\zeta)(\D{x})(s) \defeq \DD{\trajectory(t)(x)(s)}{t}(\zeta) \stackrel{!}{=} \ivaluation{\iconcat[state=\trajectory(\zeta+s)]{\IddL}}{\astrm}$ and satisfies $\ivr$ for all $s\in[-\min\Set{\zeta,T},0]$. On $[-T,-\min\Set{\zeta,T})$ it holds $\trajectory(\zeta)(\cdot)(s)=\asstate(\cdot)(s+\zeta)$ for all variables.
            % TODO: case r=0
        \end{enumerate}
    \end{definition}
    The semantics of a delay differential equation is motivated by the definition of a solution for a DDE-IVP (cf.\ Definition~\ref{def:solution-dde}), following the evolution for a nondeterministic period of time, as long as the evolution domain constraint holds.

    % To facilitate notation, we define a \emph{satisfaction relation} with respect to a DDE: the trajectory $\trajectory$ (which is a set of states) is said to \emph{satisfy} $\hevolvein{\D{x}=\astrm}{\ivr}$, written as $\trajectory\models\hevolvein{\D{x}=\astrm}{\ivr}$
    % TODO: :  fulfills DDE 
    % $\trajectory$ solves the DDE and satisfies $\ivr$ in each time instant/state

    % The formula $\hevolve{\D{x}=\astrm(-\tau)}\land\ivr$ has dropped the $\hs{}$, all occurences of $x$ and $\D{x}$ of form with constant

    % TODO: if $r=0$: 
    initial value $\asstate(\D{x})$ may not be compatible with derivative
    final values coincide

    For the \emph{discrete assignment}, we only allow the values at the current time instant to be changed. A functional assignment would essentially allow to rewrite history, which is not permitted.

    The jump behavior caused be discrete assignments is the actual reason why we need to consider piecewise continuous evolutions.

    Time is implicit and usually not revealed. If it is explicitely needed, a clock variable $t$ can be introduced by $\hevolve{\D{t}=1}$.

    %TODO: super dense time: multiple assignments, only consider last assignment

    % in general, we do not write expression explicitely, just give possible intervals in precondition
    
    As a \FOLR formula, $\ivr$ do not contain any delayed variables and thus only depends on the values at the current time instant (and not over the entire interval $\delayinterval$).

    \begin{lemma}[Derivations]\label{lm:derivations}
        Standard analysis derivation rules also hold in the semantics of \ddL terms, i.e.\ the following equations are valid \ddL formulas
        \begin{align}
            \D{(\x[s])} &= \Dx[s]\\
            %\Dx[s] &=\\
            \D{(\x[c])} &= \Dx[c]\\
            %\Dx[b] &=\\
            \D{(a)} &= 0\\
            \D{(f(\range{\istrm{1}}{\istrm{k}}))} &=\\
            \D{(\astrm+\bstrm)} &= \D{(\astrm)}+\D{(\bstrm)}\\
            \D{(\astrm\cdot\bstrm)} &= \D{(\astrm)}\cdot\bstrm + \astrm\cdot\D{(\bstrm)}\\
            % FIXME: is term' allowed? diff inv is only a FOLR formula? even for dL valid?
            %\D{(\astrm)}
        \end{align}
        This allows to apply these rules on a syntactic level, what will be done in the form of axioms (see~\ref{sec:differential-axioms}).
    \end{lemma}
    \begin{proof}
        \begin{align*}
            % FIXME: semantics of x': must coincide with deriv of x
            % FIXME: semantics of Derivation: no I(s) and nu(s)
            \ivaluation{\IddL}{\D{(\x[s])}}
            &= \sum_{\x[c]\in\delayvars} \asstate(\D{x})(c)\frac{\partial\ivaluation{\IddL}{\x[s]}}{\partial \x[c]}+ \asstate(\D{x})(\past)\frac{\partial\ivaluation{\IddL}{\x[s]}}{\partial \x[s]}\\
            &= \asstate(\D{x})(\past)\frac{\partial\ivaluation{\IddL}{\x[s]}}{\partial \x[s]}
            = \asstate(\D{x})(\past) = \ivaluation{\IddL}{\Dx[s]}
        \end{align*}
        \begin{align*}
            % delayed derivative
            \ivaluation{\IddL}{\D{(\x[c])}}
            &= \sum_{\x[d]\in\delayvars} \asstate(\D{x})(d)\frac{\partial\ivaluation{\IddL}{\x[c]}}{\partial \x[d]}+ \asstate(\D{x})(\past)\frac{\partial\ivaluation{\IddL}{\x[c]}}{\partial \x[s]}\\
            &= \asstate(\D{x})(c)\frac{\partial\ivaluation{\IddL}{\x[c]}}{\partial \x[c]}
            = \asstate(\D{x})(c) = \ivaluation{\IddL}{\Dx[b]}
        \end{align*}
        \begin{align*}
            % constant
            \ivaluation{\IddL}{\D{(a)}}
            &= \sum_{\x[c]\in\delayvars} \asstate(\D{x})(c)\frac{\partial\ivaluation{\IddL}{a}}{\partial \x[c]}\\
            % &= \asstate(\D{x})(c)\frac{\partial\interpret[a]}{\partial \x[c] 
            = 0
        \end{align*}
        \begin{align*}
            % chain rule
            % FIXME: derivation of function symbol
            \ivaluation{\IddL}{\D{(f(\range{\istrm{1}(s)}{\istrm{k}(s)}))}} &= \sum_{\x[c]\in\delayvars} \asstate(\D{x})(c)\frac{\partial\ivaluation{\IddL}{f(\range{\istrm{1}(s)}{\istrm{k}(s)})}}{\partial \x[c]}\\ &+ \asstate(\D{x})(\past)\frac{\partial\ivaluation{\IddL}{f(\range{\istrm{1}(s)}{\istrm{k}(s)})}}{\partial \x[s]}
        \end{align*}
        \begin{align*}
            % addition rule
            \ivaluation{\IddL}{\D{(\astrm(s)+\bstrm(s))}}
            &= \sum_{\x[c]\in\delayvars} \asstate(\D{x})(c)\frac{\partial\ivaluation{\IddL}{\astrm(s)+\bstrm(s)}}{\partial \x[c]} + \asstate(\D{x})(\past)\frac{\partial\ivaluation{\IddL}{\astrm(s)+\bstrm(s)}}{\partial \x[s]}\\
            &= \sum_{\x[c]\in\delayvars} \asstate(\D{x})(c)\frac{\partial\ivaluation{\IddL}{\astrm(s)}+\ivaluation{\IddL}{\bstrm(s)}}{\partial \x[c]} + \asstate(\D{x})(\past)\frac{\partial\ivaluation{\IddL}{\astrm(s)}+\ivaluation{\IddL}{\bstrm(s)}}{\partial \x[s]}\\
            &= \sum_{\x[c]\in\delayvars} \asstate(\D{x})(c)\frac{\partial\ivaluation{\IddL}{\astrm(s)}}{\partial \x[c]} + \asstate(\D{x})(\past)\frac{\partial\ivaluation{\IddL}{\astrm(s)}}{\partial \x[s]}\\
            &+ \sum_{\x[c]\in\delayvars} \asstate(\D{x})(c)\frac{\partial\ivaluation{\IddL}{\bstrm(s)}}{\partial \x[c]} + \asstate(\D{x})(\past)\frac{\partial\ivaluation{\IddL}{\bstrm(s)}}{\partial \x[s]}\\
            &= \ivaluation{\IddL}{\D{(\astrm(s))}} + \ivaluation{\IddL}{\D{(\bstrm(s)}}
            = \ivaluation{\IddL}{\D{(\astrm(s))}+\D{(\bstrm(s))}}
        \end{align*}
        \begin{align*}
            % multiplication rule
            \ivaluation{\IddL}{\D{(\astrm(s)\cdot\bstrm(s))}}
            &= \sum_{\x[c]\in\delayvars} \asstate(\D{x})(c)\frac{\partial\ivaluation{\IddL}{\astrm(s)\cdot\bstrm(s)}}{\partial \x[c]} + \asstate(\D{x})(\past)\frac{\partial\ivaluation{\IddL}{\astrm(s)\cdot\bstrm(s)}}{\partial \x[s]}\\
            &= \sum_{\x[c]\in\delayvars} \asstate(\D{x})(c)\frac{\partial\left(\ivaluation{\IddL}{\astrm(s)}\cdot\ivaluation{\IddL}{\bstrm(s)}\right)}{\partial \x[c]} + \asstate(\D{x})(\past)\frac{\partial\left(\ivaluation{\IddL}{\astrm(s)}\cdot\ivaluation{\IddL}{\bstrm(s)}\right)}{\partial \x[s]}\\
            &= \sum_{\x[c]\in\delayvars} \asstate(\D{x})(c)\frac{\partial\ivaluation{\IddL}{\astrm(s)}}{\partial \x[c]}\ivaluation{\IddL}{\bstrm(s)} + \asstate(\D{x})(\past)\frac{\partial\ivaluation{\IddL}{\astrm(s)}}{\partial \x[s]}\ivaluation{\IddL}{\bstrm(s)}\\
            &+ \sum_{\x[c]\in\delayvars} \asstate(\D{x})(c)\frac{\partial\ivaluation{\IddL}{\bstrm(s)}}{\partial \x[c]}\ivaluation{\IddL}{\astrm(s)} + \asstate(\D{x})(\past)\frac{\partial\ivaluation{\IddL}{\bstrm(s)}}{\partial \x[s]}\ivaluation{\IddL}{\astrm(s)}\\
            &= \ivaluation{\IddL}{\D{(\astrm(s))}}\cdot\ivaluation{\IddL}{\bstrm(s)} + \ivaluation{\IddL}{\astrm(s)}\cdot\ivaluation{\IddL}{\D{(\bstrm(s)}}\\
            &= \ivaluation{\IddL}{\D{(\astrm(s))}\cdot\bstrm(s)+\astrm(s)\cdot\D{(\bstrm(s)}}
        \end{align*}
        
    \end{proof}

    \begin{definition}\label{def:termvars}
        We define by
        \begin{equation*}
            % TODO: what if x'[] in term ?
            \constants[\astrm] \defeq \Set{c\in\constants \with \mexists{\x\in\allvars}\holds\x[c]\in\astrm(s)}
        \end{equation*}
        the set of constant parameter symbols occuring in the s-term $\astrm(s)$.

        Note that this set does not contain $s$, since it is, as a special purpose symbol, not in $\constants$.
    \end{definition}

    \begin{definition}[Sampled trajectory]\label{def:sampled-trajectory}
        Since a s-term $\astrm(s)$ only comprises a finite number of atomic terms, its valuation can also be seen as a mapping
        \begin{equation*}
            \ivaluation{\interpretation[const=\interpret]}{\astrm(s)} \from \R^{\abs{\mathcal{K}}} \to \R  
        \end{equation*}
        % TODO: what about x'
        from the concrete values for each element of $\mathcal{K}\defeq \delayvars[\astrm] \cup \delaydiffvars[\astrm] \cup \Set{\x[s], \Dx[s]}$ into the reals, if we assign a fixed $r\in\closeddelayinterval$ to $s$.

        % , instead of using the functional state space as domain.

        This gives rise to the definition of the \emph{sampled trajectory} $\sampledtraj[\past]{\astrm}\from\compactum{0}{\duration}\to\R^{\abs{\mathcal{K}}}$ for a fixed $\past\in\closeddelayinterval$ and s-term $\astrm(s)$ (without loss of generality, considering $\allvars=\Set{x}$)
        % FIXME: differnt vars possible, not just x
        \begin{equation*}
            \sampledtraj[\past]{\astrm}(t) \defeq \colvec{
                \trajectory(t)(x)(c_1)\\
                \vdots\\
                \trajectory(t)(x)(c_n)
            % \\ \vdots\\ \trajectory(t)(x_m)(c_1)\\ \vdots\\ \trajectory(t)(x_m)(c_n)
            }
        \end{equation*}
    \end{definition}
    % TODO: alternatively, could maybe have \trajectory FrÃ©chet-diffable

    The following lemma shows the consistency of the semantics for differentials with the semantics of the evolution of a delay differential equation.
    This means that along a DDE, the values of differential symbols coincide with the time derivative of the value of the corresponding variable.
    % Derivative means right-hand in points of partition.

    \begin{lemma}[Differential Lemma]\label{lm:differential-lemma}
        % FIXME: check if everywhere correctly used: \states=(\statespace)^n
        The value of a s-term $\bstrm(s)$ along a trajectory $\trajectory\from\compactum{0}{\duration}\to\states$ satisfying a DDE for any duration $\duration>0$, i.e.
        % FIXME:doFormatList does not work with iconcat $\imodels{\iconcat[state=\trajectory]{\IddL}}{\D{x}=\asfml\land\ivr}$
        $\interpret,\trajectory\models(\D{x}=\astrm\land\ivr)$,
        % FIXME: do I need case s=0?
        is piecewise continuously differentiable and for all $\zeta\in\compactum{0}{\duration}$ and $\past\in\closeddelayinterval$ it holds:
        \begin{equation*}
            \ivaluation{\iconcat[state=\trajectory(\zeta)]{\IddL}}{\D{(\bstrm(s))}} = \DD{\ivaluation{\iconcat[state=\trajectory(t)]{\IddL}}{\bstrm(s)}}{t}(\zeta)
        \end{equation*}
        As in Definition~\ref{def:pw-cont-diff}, the derivative at a discontinuity point of is to be understood as right derivative.
    \end{lemma}
    \begin{proof}
        \label{prf:differential-lemma}
        % TODO: what if x'[] in term ?
        % TODO: in init cond: x and x' need to match, ie d/ds x[s] = x'[s], same partition, specification of x' in init cond only needed when referenced to it later
        % FIXME: oBdA: t_0=0

        Without loss of generality, we restrict in this proof to a single variable $x$. If $\bstrm(s)$ depends on more variables, consider the union of their partitions in the initial condition.
        Let $\partition{-T=t_0}{t_m=0}$ be the partition of the initial condition $\trajectory(0)(x)\in\statespace$.

        We choose an arbitray but fixed valuation for $s$ from $\closeddelayinterval$, such that the symbol $s$ can be treated as a constant, in the same way as any $c\in\nonposQ$.
        Depending on the s-term $\bstrm(s)$ and the fixed $s$, we define a partition $\mathcal{Z}_\bstrm^s=\partition{\hat{t}_0}{\hat{t}_p}$ of $\closedopen{0}{\infty}$ (which can be limited to $\compactum{0}{R}$) by
        \begin{equation*}
            \mathcal{Z}_\bstrm^s \defeq \set{0}\cup \bigcup_{i=0}^m\bigcup_{\substack{c\in \mathcal{K}\\ t_i\geq c}}\set{t_i-c}\cup \bigcup_{i=0}^m\bigcup_{j=1}^k\bigcup_{\substack{c\in \mathcal{K}\\ t_i+\tau_j\geq c}}\set{t_i+\tau_j-c}
        \end{equation*}
        where $\mathcal{K}\defeq\constants[\bstrm]\cup\set{s}$ is the set of the constants (the interpretations/valuations of the constant symbols) appearing in the term $\bstrm$ and $\tau_j\in\constants[\astrm]$ the delays in the right hand side of the DDE.
        The set $\mathcal{Z}_\bstrm^s$ is finite and non-empty, since it contains at least the value $0$ and $\duration$.
        % FIXME
        % in side of a continuous diffable piece of init cond or solution (cf.)

        We show first that $\trajectory(t)(x)(c)$ is piecewise continuously differentiable in $t$ for all $c\in\mathcal{K}$ with partition $\mathcal{Z}_\bstrm^s$:

        Let $c\in\mathcal{K}$ and $\zeta\in(\hat{t}_l,\hat{t}_{l+1})$.
        Assume that $\zeta+c=t_i$ for some $i$. This implies $\zeta=t_i-c=\hat{t}_k$ for some $k$ by the definition of the partition. This is not possible by the choice of $\zeta$ lying between two consequtive $\hat{t}_l$.
        We apply the same argumentation to the assumption $\zeta+c=t_i+\tau_j$.
        These contradictions show that for $\zeta\in(\hat{t}_j,\hat{t}_{j+1})$, it holds that $\zeta+c\neq t_i$ and $\zeta+c\neq t_i+\tau_j$ for all $c\in\mathcal{K}$ and for all $i\in\Set{\range{0}{m}}$, $j\in\set{\range{1}{k}}$.
        We now distinguish two cases:

        If $\zeta+c<0$, it holds by the definition of the DDE semantics (Definition~\ref{def:semantic-HP}(\ref{itm:sem-HP-DDE})) that $\trajectory(\zeta)(x)(c)=\trajectory(0)(x)(\zeta+c)$, which is continuously differentiable as initial condition, if $\zeta+c\neq t_i$. Hence it follows
        \begin{equation*}
            \DD{\trajectory(t)(x)(c)}{t}(\zeta)=\DD{\trajectory(0)(x)(\past)}{\past}(\zeta+c)=\trajectory(0)(\D{x})(\zeta+c)=\trajectory(\zeta)(\D{x})(c)
        \end{equation*}
        For the right limit it holds
        \begin{align*}
            \lim_{\zeta\downto\hat{t}_j} \DD{\trajectory(t)(x)(c)}{t}(\zeta)
                & = \lim_{\zeta\downto t_i-c} \DD{\trajectory(0)(x)(\past)}{\past}(\zeta+c)\\
                & = \lim_{\zeta\downto t_i} \DD{\trajectory(0)(x)(\past)}{\past}(\zeta)
                %=\lim_{s\downto t_i}\trajectory(0)(\D{x})(s)
                = \trajectory(0)(\D{x})(t_i)
        \end{align*}
        And analogously for the existence of the left limit for $\zeta\upto\hat{t}_{j+1}$

        If $\zeta+c\geq 0$, then $\trajectory(\zeta)(x)(\past)=\trajectory(\zeta+c)(x)(0)$ is differentiable in $\zeta$ with
        \begin{equation*}
            \trajectory(\zeta)(\D{x})(\past) = \DD{\trajectory(t)(x)(\past)}{t}(\zeta)
        \end{equation*}
        by the semantics of the DDEs, if $\zeta+c\neq t_i+\tau_j$.
        % FIXME: jumppoints and pw conitnuity/diffable
        % By Theorem~\ref{thm:solution-existence}: continuous and pw diffable with partition $Z$.

        % By definition, $\hat{t}_j=t_i-\hat{c}$ for some $i\in\set{\range{0}{m}}$ and $\hat{c}\in\mathcal{K}$.
        % If $c\geq\hat{c}$ then $\zeta>\hat{t}_j$ implies $\zeta+c > c+t_i-\hat{c}\geq t_i$.
        % If $c<\hat{c}$, then $\zeta < \hat{t}_{j+1} \leq t_i-c$ (needs explanation: tjp1 is smallest next point, construct one, must be greater or equal) and hence $\zeta+c<t_i$.
        % So whenever $\zeta\in(\hat{t}_j,\hat{t}_{j+1})$ is $\zeta+c\neq t_i$ for all $i=\range{0}{m}$ and $c\in\mathcal{K}$

        %On each $\zeta\in(\hat{t}_k,\hat{t}_{k+1})$ is each $\ivaluation{\iconcat[state={\trajectory(\zeta)},assign=s]{\IddL}}{\x[c]}$ diffable in $\zeta$

        % TODO: f in terms smooth, hence each term on this open interval diffable
        Let $\sampledtraj[s]{\bstrm}$ be the $\bstrm$-sampled trajectory for the considered delay differential equation and the fixed $s$.
        It follows with the above results
        % By the transition semantics of DDEs (Definition~\ref{def:semantic-HP}\,(\ref{itm:sem-HP-DDE})), it holds for $\zeta+c\geq 0$ (along sol of DDE)
        % $\trajectory(\zeta)(\D{x})(c) = \DD{\trajectory(t)(x)(c)}{t}(\zeta)$, and for $\zeta+c\leq 0$ (init cond, match demanded)

        \begin{align*}
            \DD{\ivaluation{\iconcat[state={\sampledtraj[s]{\bstrm}(\zeta)},assign={}]{\IddL}}{\bstrm}}{t}
            &= \D{\left(\ivaluation{\iconcat[state={},assign={}]{\IddL}}{\bstrm}\compose\sampledtraj[s]{\bstrm}(\zeta)\right)}
            = \gradient{\ivaluation{\iconcat[state={},assign={}]{\IddL}}{\bstrm}}(\sampledtraj[s]{\bstrm}(\zeta))\cdot\DD{\sampledtraj[s]{\bstrm}}{t}(\zeta)\\
            &= \sum_{\x[c]\in\delayvars[\bstrm]}\DD{\trajectory(t)(x)(c)}{t}(\zeta) \Dp[{(\x[c])}]{\ivaluation{\iconcat[state={\sampledtraj[s]{\bstrm}(\zeta)},assign=s]{\IddL}}{\bstrm}}\\
            % &= \sum_{\x[c]\in\delayvarswiths}\trajectory(\zeta)(\Dx[c])(s) \Dp[{(\x[c])}]{\ivaluation{\iconcat[state={\sampledtraj[s]{\bstrm}(\zeta)},assign=s]{\IddL}}{\bstrm}}{(s)}\\
            &= \sum_{\x[c]\in\delayvars}\trajectory(\zeta)(\D{x})(c) \Dp[{(\x[c])}]{\ivaluation{\iconcat[state={\sampledtraj[s]{\bstrm}(\zeta)},assign=s]{\IddL}}{\bstrm}}\\
            %&= \sum_{\x[c]\in\delayvarswiths}\asstate(\D{x})(c) \Dp[{(\x[c])}]{\ivaluation{\IddL}{\bstrm}}{(s)}\\
            &= \ivaluation{\iconcat[state={\sampledtraj[s]{\bstrm}(\zeta)},assign={}]{\IddL}}{\D{(\bstrm})}
        \end{align*}
        where each sum only consits of finitely many summands.
        Moreover, it holds for the right limits
        \begin{equation*}
            \lim_{\zeta\downto\hat{t}_j} \DD{\ivaluation{\iconcat[state={\sampledtraj[s]{\bstrm}(\zeta)},assign=s]{\IddL}}{\bstrm}}{t} = \ivaluation{\iconcat[state={\sampledtraj[s]{\bstrm}(\hat{t}_j)},assign={}]{\IddL}}{\D{(\bstrm})}
        \end{equation*}
        and the left limits for $\zeta\upto\hat{t}_{j+1}$ exist.
    \end{proof}

    \begin{figure}[t]
        \centering
        \input{figures/differential-lemma.tikz}
        \caption{Plot for Example~\ref{ex:differential-lemma}, initial condition and solution of DDE (dashed), derivatives (dotted), value of term (solid) and the derivative of the term (dash-dotted).}
        \label{fig:differential-lemma}
    \end{figure}

    \begin{example}\label{ex:differential-lemma}
        As an example for the construction of the partition in Proof~\ref{prf:differential-lemma}, consider the s-term $\bstrm(s)\equiv x+\x[-3.5]+\x[s]$ together with the DDE $\D{x}=\x[-4]$.
        Let
        \begin{equation*}
            \mathcal{Z} = \Set{-4,-3.25,-2,-1.2,0}
        \end{equation*}
        be the partition of some initial condition.
        Choosing $\past=-1.8$ for $s$, we obtain
        \begin{equation*}
            \mathcal{Z}_\bstrm^\past = \set{0,0.25,0.6,0.75,1.5,1.8,2,2.3,2.55,2.8,3.5,3.8,4}
        \end{equation*}
        when we restrict the evolution to $\compactum{0}{4}$.
        Figure~\ref{fig:differential-lemma} depicts an example for the piecewise continuous differentiability of the term's evolution, given some initial condition.
        % \begin{equation*}
        %     \D{\left(\hs{x+\x[c]+\x[s]\geq 0}\right)} \equiv \hs{\D{x}+\Dx[c]+\Dx[s]\geq 0}
        % \end{equation*}
        
        % then $g_s\in\Cnpw[1]{\compactum{0}{r}}{\R}$ along traj de dde
        % \begin{equation*}
        %     g_s(t)=\ivaluation{\iconcat[state=\trajectory(t),assign=s]{\IddL}}{\bstrm} = \ivaluation{\iconcat[state=\trajectory(t),assign=s]{\IddL}}{\x[0]} + \ivaluation{\iconcat[state=\trajectory(t),assign=s]{\IddL}}{\x[c]} + \ivaluation{\iconcat[state=\trajectory(t),assign=s]{\IddL}}{\x[s]}
        % \end{equation*}
        % each summand diffable in $(\hat{t}_j,\hat{t}_{j+1})$ and
        % \begin{equation*}
        %     \D{g}_s(t)= \ivaluation{\iconcat[state=\trajectory(t),assign=s]{\IddL}}{\Dx[0]} + \ivaluation{\iconcat[state=\trajectory(t),assign=s]{\IddL}}{\Dx[c]} + \ivaluation{\iconcat[state=\trajectory(t),assign=s]{\IddL}}{\Dx[s]}
        % \end{equation*}
        % \begin{equation*}
        %     \lim_{\zeta\downto\hat{t}_j} \D{g}_s(\zeta)=
        % \end{equation*}
    \end{example}

    % FIXME: replace duration r
    \begin{lemma}[Differential assignment]\label{lm:diff-assignment}
        Let $\trajectory\from\compactum{0}{\duration}\to\states$ be a trajectory satisfying a DDE for any duration $\duration\geq 0$, i.e.
        $\interpret,\trajectory\models(\D{x}=\astrm\land\ivr)$.
        Then it holds:
        \begin{equation*}
            \interpret,\trajectory,\past\models\asfml(s) \lbisubjunct \trajectory(\zeta)\in\imodel{\IddL}{\dbox{\Dupdate{\Dumod{\D{x}}{\astrm}}}{\asfml(s)}}  
        \end{equation*}
    \end{lemma}
    \begin{proof}
        Let $\zeta\in\compactum{0}{\duration}$. It is $\trajectory(\zeta)\in\imodel{\IddL}{\Dx[0]=\astrm}$ and $\trajectory(\zeta)\in\imodel{\IddL}{\ivr}$, which means $\trajectory(\zeta)(\D{x})(0)=\ivaluation{\iconcat[state=\trajectory(\zeta)]{\IddL}}{\astrm}$, since $\astrm$ is independent of $s$.
        By Definition~\ref{def:semantic-dHP}(\ref{itm:sem-dHP-assgn}) of the assignment's semantics, this implies $(\trajectory(\zeta),\bsstate)\in\ireachability{\IddL}{\Dupdate{\Dumod{\D{x}}{\astrm}}}$ if and only if $\bsstate=\trajectory(\zeta)$.
        Finally, this implies the equivalence
        \begin{align*}
            \trajectory(\zeta)\in\imodel{\IddL}{\asfml(s)} &\lbisubjunct
            \mforall{\bsstate\in\states}\holds\left((\trajectory(\zeta),\bsstate)\in\ireachability{\IddL}{\Dupdate{\Dumod{\D{x}}{\astrm}}} \limply \bsstate\in\imodel{\IddL}{\asfml(s)}\right)\\
            &\lbisubjunct \trajectory(\zeta)\in\imodel{\IddL}{\dbox{\Dupdate{\Dumod{\D{x}}{\astrm}}}{\asfml(s)}}
        \end{align*}
    \end{proof}

% \section{Static Semantics}
%     \label{sec:static-semantics}

%     \subsection{History Horizon}
%         \label{sec:history-horizon}

%         \begin{definition}[History Horizon]
%             The \emph{history horizon} is a function
%             \begin{equation*}
%                 \HHfml\from \ddLformulas \to \nonposR
%             \end{equation*}
%             which assigns to each \ddL formula the earliest point in time it references to. It limits the time interval of the state space $T\in$.
%             The history horizon depends on all occurences of $\x[s]$ and $\x[c]$ in the formula.

%             It is defined inductively for formulas by:
%             \begin{enumerate}
%                 \item $\HHfml(\hs{\astrm\geq\bstrm}) = \max\set{\HHtrm(\astrm),\HHtrm(\bstrm)}$
%                 \item $\HHfml(\hs{p(\range{\istrm{1}}{\istrm{k}})}) = \max\set{\range{\HHtrm(\istrm{1})}{\HHtrm(\istrm{k})}}$
%                 \item $\HHfml(\contextapp{C}{\asfml}) = $
%                 \item $\HHfml(\lnot\asfml) = \HHfml(\asfml)$
%                 \item $\HHfml(\asfml\land\bsfml) = \max\set{\HHfml(\asfml),\HHfml(\bsfml)}$
%                 \item $\HHfml(\lforall{x}{\asfml}) = \HHfml(\asfml)$
%                 \item $\HHfml(\lexists{x}{\asfml}) = \HHfml(\asfml)$
%                 \item $\HHfml(\dbox{\asprg}{\asfml}) = \max\set{\HHprg(\asprg),\HHfml(\asfml)}$
%                 \item $\HHfml(\ddiamond{\asprg}{\asfml}) = \max\set{\HHprg(\asprg),\HHfml(\asfml)}$
%             \end{enumerate}
%             depending on terms
%             \begin{enumerate}
%                 \item $\HHtrm(\x[s]) = 0$
%                 \item $\HHtrm(\Dx[s]) = 0$
%                 \item $\HHtrm(\x[c]) = \abs{c}$
%                 \item $\HHtrm(\Dx[c]) = \abs{c}$
%                 \item $\HHtrm(c) = 0$
%                 \item $\HHtrm(f(\range{\istrm{1}}{\istrm{k}})) = \max\set{\range{\HHtrm(\istrm{1})}{\HHtrm(\istrm{k})}}$
%                 \item $\HHtrm(\astrm + \bstrm) = \max\set{\HHtrm(\astrm),\HHtrm(\bstrm)}$
%                 \item $\HHtrm(\astrm \cdot \bstrm) = \max\set{\HHtrm(\astrm),\HHtrm(\bstrm)}$
%             \end{enumerate}
%             and \HPs
%             \begin{enumerate}
%                 \item $\HHprg(a) = 0$
%                 \item $\HHprg(\hupdate{\humod{x}{\astrm}}) = 0$
%                 \item $\HHprg(\Dupdate{\Dumod{\D{x}}{\astrm}}) = 0$
%                 \item $\HHprg(\htest{\asfmlfolR}) = 0$
%                 \item $\HHprg(\hchoice{\asprg}{\bsprg}) = \max\set{\HHprg(\asprg),\HHprg(\bsprg)}$
%                 % TODO: replace ; in HPs
%                 \item $\HHprg(\asprg;\bsprg) = \max\set{\HHprg(\asprg),\HHprg(\bsprg)}$
%                 \item $\HHprg(\hrepeat{\asprg}) = \HHprg(\asprg)$
%                 \item $\HHprg(\hevolvein{\D{x}=\astrm(-\tau)}{\ivr}) = \HHtrm(\astrm(-\tau))$
%             \end{enumerate}
%             For formulae as
            
%             T in forall: comp, pred
%             minimum of T in forall parts of subformulas: quantifier, not and
%             forall, exists?
%             modalities: max $\tau$ in DDE and of formula
%         \end{definition}
%         %We need to use $\min$, since $\HH$ is a non-positive number. It is the biggest in absolute value.
    
%     \subsection{Variable Binding}
%         \label{sec:variable-binding}

%         \begin{definition}[Free variable]
%             for terms: $\freevars{\astrm}\subseteq\allvars\cup\diffvars\cup\set{s}$, variables that occur in term
%             \begin{align*}
%                 \freevars{\x[s]} &= \set{x,s}\\
%                 \freevars{\Dx[s]} &= \set{\D{x},s}\\
%                 \freevars{\x[b]} &= \set{x}\\
%                 \freevars{\Dx[b]} &= \set{\D{x}}\\
%                 \freevars{c} &= \emptyset\\
%                 \freevars{f(\range{\istrm{1}}{\istrm{k}})} &= \freevars{\istrm{1}} \cup\cdots\cup \freevars{\istrm{k}}\\
%                 \freevars{\astrm + \bstrm} = \freevars{\astrm \cdot \bstrm} &= \freevars{\astrm}\cup\freevars{\bstrm}\\
%                 \freevars{\D{(\astrm)}} &= \freevars{\astrm}\cup\D{\freevars{\astrm}}
%             \end{align*}
                
%         \end{definition} 

%         only bound variables can change in the execution of a \HP   

%     \subsection{Well-defined Formulae}
%         \label{sec:well-definedness}
    
%         $s$ must not be free
%         and

%         \begin{definition}[Well-defined formula]
%             obeys syntactic definition
%             premisse defines element od statespace for all occuring variables and diffs
%         \end{definition}

%         \begin{example}
%             \begin{equation*}
%                 % FIXME: notation/syntax: ausgeklammertes forall in formulas
%                 \dbox{\hupdate{\humod{x}{\x[-3]^2}};\hevolvein{\D{x}=\x[-\tau]+2x}{(x\geq 0)}}{\hsc{0\leq \x[s] \land \x[s]\leq\x[-5]}}
%             \end{equation*}
%             Hence the history horizon needs to be set to
%             \begin{equation*}
%                 T=\max\set{\max\set{3,\tau},\max\set{0,5}}.
%             \end{equation*}
%         \end{example}

%         % TODO: feasible history horizon for a HP
%         \begin{lemma}
%             choosing the statespace according to history horizon of HP determines
%         \end{lemma}

%         \begin{example}
            
%         \end{example}
